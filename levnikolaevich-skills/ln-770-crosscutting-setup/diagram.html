<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-770-crosscutting-setup - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-770-crosscutting-setup</h1>
    <p>L2 Domain Coordinator - Configures logging, error handling, CORS, health checks, and API docs</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> Analyze: Start Crosscutting Setup

    Analyze --> Execute: Stack Detected

    state Execute {
        [*] --> Logging
        Logging --> Errors: Logging Ready
        Errors --> CORS: Error Handling Ready
        CORS --> Health: CORS Ready
        Health --> Swagger: Health Checks Ready
        Swagger --> [*]: API Docs Ready

        Logging: ln-771 Logging Configurator
        Errors: ln-772 Error Handler Setup
        CORS: ln-773 CORS Configurator
        Health: ln-774 Healthcheck Setup
        Swagger: ln-775 API Docs Generator
    }

    Execute --> Verify: All Configured
    Verify --> [*]: Complete
    </div>

    <h2>Cross-cutting Concerns Architecture</h2>
    <div class="mermaid">
flowchart TD
    Request([Incoming Request]) --> CORS{CORS Check}

    CORS -->|Allowed| Logging[Request Logging]
    CORS -->|Blocked| CORSError[403 Forbidden]

    Logging --> Route{Route Match?}

    Route -->|/health| Health[Health Check Handler]
    Route -->|/swagger| Swagger[Swagger UI]
    Route -->|/api/*| Controller[Controller]

    Controller --> Try{Try Execute}
    Try -->|Success| Response[Response Logging]
    Try -->|Exception| ErrorHandler[Global Error Handler]

    ErrorHandler --> ErrorLog[Log Exception]
    ErrorLog --> ErrorResponse[Error Response]

    Response --> Client([Response to Client])
    ErrorResponse --> Client
    Health --> Client
    Swagger --> Client
    CORSError --> Client

    classDef middleware fill:#E6E6FA
    classDef endpoint fill:#90EE90
    classDef error fill:#FFB6C1
    class CORS,Logging,ErrorHandler middleware
    class Health,Swagger,Controller endpoint
    class CORSError,ErrorResponse error
    </div>

    <h2>Logging Configuration by Stack</h2>
    <div class="mermaid">
flowchart TD
    Stack{Technology Stack?}

    Stack -->|.NET| Serilog[Serilog]
    Stack -->|Python| Structlog[structlog]

    Serilog --> JSON1[JSON Structured Logs]
    Structlog --> JSON2[JSON Structured Logs]

    subgraph Fields["Standardized Fields"]
        timestamp
        level
        message
        correlationId
        userId
        requestPath
        responseTime
    end

    JSON1 --> Fields
    JSON2 --> Fields

    classDef logger fill:#87CEEB
    class Serilog,Structlog logger
    </div>

    <h2>Error Response Format</h2>
    <div class="mermaid">
flowchart LR
    Exception([Exception Thrown]) --> Handler[Global Handler]

    Handler --> Classify{Exception Type?}

    Classify -->|Validation| E400[400 Bad Request]
    Classify -->|NotFound| E404[404 Not Found]
    Classify -->|Auth| E401[401 Unauthorized]
    Classify -->|Internal| E500[500 Internal Error]

    subgraph Response["Error Response"]
        Code[error.code]
        Message[error.message]
        Details[error.details]
        TraceId[error.traceId]
    end

    E400 --> Response
    E404 --> Response
    E401 --> Response
    E500 --> Response

    classDef error fill:#FFB6C1
    classDef field fill:#FFD700
    class E400,E404,E401,E500 error
    class Code,Message,Details,TraceId field
    </div>

    <h2>Health Check Endpoints</h2>
    <div class="mermaid">
flowchart TD
    subgraph Endpoints["Health Endpoints"]
        Live[/health/live]
        Ready[/health/ready]
        Full[/health]
    end

    Live --> LiveCheck{App Running?}
    LiveCheck -->|Yes| Live200[200 OK]
    LiveCheck -->|No| Live503[503 Unavailable]

    Ready --> ReadyCheck{Dependencies OK?}
    ReadyCheck --> DB[(Database)]
    ReadyCheck --> Cache[(Redis)]
    ReadyCheck --> Queue[(Message Queue)]

    DB --> AllOK{All Healthy?}
    Cache --> AllOK
    Queue --> AllOK

    AllOK -->|Yes| Ready200[200 OK]
    AllOK -->|No| Ready503[503 Unavailable]

    Full --> Detailed[Detailed Status JSON]

    classDef healthy fill:#90EE90
    classDef unhealthy fill:#FFB6C1
    class Live200,Ready200 healthy
    class Live503,Ready503 unhealthy
    </div>

    <footer>
        <p>ln-770-crosscutting-setup v2.0.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
