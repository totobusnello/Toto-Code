<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-712-nuget-upgrader - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-712-nuget-upgrader</h1>
    <p>L3 Worker - Upgrades .NET NuGet packages</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> FindProjects: Start

    FindProjects --> SecurityAudit: Projects Found
    SecurityAudit --> CheckOutdated: Audit Pass
    SecurityAudit --> Report: Critical CVE Found

    CheckOutdated --> IdentifyBreaking: Outdated Found
    CheckOutdated --> Report: All Up-to-date

    IdentifyBreaking --> ApplyUpgrades: Breaking Changes Mapped
    ApplyUpgrades --> RestoreBuild: Packages Updated

    RestoreBuild --> Report: Build Pass
    RestoreBuild --> Rollback: Build Fail

    Rollback --> ApplyUpgrades: Retry Next Package

    Report --> [*]: Complete
    </div>

    <h2>Project Discovery</h2>
    <div class="mermaid">
flowchart TD
    Start([Receive Context]) --> CheckSln{Has .sln file?}

    CheckSln -->|Yes| ParseSln[dotnet sln list]
    CheckSln -->|No| FindCsproj[Find *.csproj files]

    ParseSln --> Projects([List of Projects])
    FindCsproj --> Projects

    Projects --> ForEach{For Each Project}
    ForEach --> CheckOutdated[dotnet outdated]
    CheckOutdated --> NextProject{More Projects?}
    NextProject -->|Yes| ForEach
    NextProject -->|No| Aggregate([Aggregate Results])

    classDef decision fill:#FFE4B5
    classDef action fill:#90EE90
    class CheckSln,NextProject decision
    class ParseSln,FindCsproj,CheckOutdated action
    </div>

    <h2>Upgrade Priority Order</h2>
    <div class="mermaid">
flowchart LR
    P1[1. SDK/Runtime] --> P2[2. Framework]
    P2 --> P3[3. EF Core]
    P3 --> P4[4. Logging]
    P4 --> P5[5. Other Packages]

    classDef critical fill:#FF6B6B
    classDef high fill:#FFE66D
    classDef normal fill:#4ECDC4
    class P1 critical
    class P2,P3 high
    class P4,P5 normal
    </div>

    <h2>Build Verification</h2>
    <div class="mermaid">
sequenceDiagram
    participant W as Worker
    participant DN as dotnet CLI
    participant Ctx as Context7/Ref

    W->>DN: dotnet restore
    DN-->>W: Restore Complete

    W->>DN: dotnet build --configuration Release
    DN-->>W: Build Result

    alt Build Fails
        W->>Ctx: Query migration guide
        Ctx-->>W: Migration steps
        W->>W: Apply fixes
        W->>DN: Rebuild
    end

    W->>DN: dotnet test
    DN-->>W: Test Results
    </div>

    <footer>
        <p>ln-712-nuget-upgrader v1.1.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
