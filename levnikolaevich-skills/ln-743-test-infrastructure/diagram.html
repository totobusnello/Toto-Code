<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-743-test-infrastructure - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-743-test-infrastructure</h1>
    <p>L3 Worker - Sets up testing frameworks and coverage tools</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> CheckExisting: Start Test Setup

    state CheckExisting {
        [*] --> ScanTestFiles
        ScanTestFiles --> EvaluateSetup
        EvaluateSetup --> [*]
    }

    CheckExisting --> Decision: Tests Evaluated

    state Decision {
        [*] --> NoTests
        [*] --> PartialSetup
        [*] --> CompleteSetup

        NoTests --> Create: Create new
        PartialSetup --> AskUser: Extend or replace?
        CompleteSetup --> Skip: Inform user
    }

    Decision --> CreateConfig: Action Determined

    state CreateConfig {
        [*] --> DetectStack
        DetectStack --> Vitest: TypeScript
        DetectStack --> xUnit: .NET
        DetectStack --> Pytest: Python
        Vitest --> [*]
        xUnit --> [*]
        Pytest --> [*]
    }

    CreateConfig --> CreateStructure: Config Created
    CreateStructure --> CreateSampleTests: Directories Created
    CreateSampleTests --> Verify: Sample Tests Added
    Verify --> [*]: Tests Passing
    </div>

    <h2>Test Framework Selection</h2>
    <div class="mermaid">
flowchart TD
    Start([Detect Stack]) --> Check{Project Type?}

    Check -->|TypeScript| TS[TypeScript/React]
    Check -->|.NET| NET[.NET]
    Check -->|Python| PY[Python]

    subgraph TS[TypeScript Stack]
        Vitest[Vitest]
        RTL[React Testing Library]
        V8[v8 Coverage]
    end

    subgraph NET[.NET Stack]
        xUnit[xUnit]
        Moq[Moq]
        Coverlet[Coverlet]
        FA[FluentAssertions]
    end

    subgraph PY[Python Stack]
        Pytest[pytest]
        PytestCov[pytest-cov]
        PytestAsync[pytest-asyncio]
    end

    TS --> Config([Config + Sample Tests])
    NET --> Config
    PY --> Config

    classDef typescript fill:#3178C6,color:white
    classDef dotnet fill:#512BD4,color:white
    classDef python fill:#3776AB,color:white
    class Vitest,RTL,V8 typescript
    class xUnit,Moq,Coverlet,FA dotnet
    class Pytest,PytestCov,PytestAsync python
    </div>

    <h2>AAA Pattern (Arrange-Act-Assert)</h2>
    <div class="mermaid">
flowchart LR
    subgraph Arrange["1. Arrange"]
        Setup[Setup test data]
        Mocks[Create mocks]
        Instance[Create instance]
    end

    subgraph Act["2. Act"]
        Execute[Execute code under test]
        Capture[Capture result]
    end

    subgraph Assert["3. Assert"]
        Verify[Verify result]
        CheckMocks[Verify mock calls]
    end

    Arrange --> Act --> Assert

    classDef arrange fill:#FFE4B5
    classDef act fill:#E6E6FA
    classDef assert fill:#90EE90
    class Setup,Mocks,Instance arrange
    class Execute,Capture act
    class Verify,CheckMocks assert
    </div>

    <h2>Coverage Thresholds</h2>
    <div class="mermaid">
flowchart TD
    Tests([Run Tests]) --> Coverage{Check Coverage}

    Coverage -->|Lines ≥ 80%| LinesOK[Lines PASS]
    Coverage -->|Lines < 80%| LinesFail[Lines FAIL]

    LinesOK --> Branches{Branches?}
    Branches -->|≥ 80%| BranchesOK[Branches PASS]
    Branches -->|< 80%| BranchesFail[Branches FAIL]

    BranchesOK --> Functions{Functions?}
    Functions -->|≥ 80%| FunctionsOK[Functions PASS]
    Functions -->|< 80%| FunctionsFail[Functions FAIL]

    FunctionsOK --> Success([All Thresholds Met])

    LinesFail --> Failure([CI FAILS])
    BranchesFail --> Failure
    FunctionsFail --> Failure

    classDef pass fill:#90EE90
    classDef fail fill:#FFB6C1
    class LinesOK,BranchesOK,FunctionsOK,Success pass
    class LinesFail,BranchesFail,FunctionsFail,Failure fail
    </div>

    <h2>Test Directory Structure</h2>
    <div class="mermaid">
flowchart TD
    subgraph TypeScript["TypeScript (Co-located)"]
        TSrc[src/]
        TComp[components/]
        TButton[Button.tsx]
        TButtonTest[Button.test.tsx]
        TSetup[test/setup.ts]

        TSrc --> TComp
        TComp --> TButton
        TComp --> TButtonTest
        TSrc --> TSetup
    end

    subgraph DotNet[".NET (Separate)"]
        NSrc[src/Project.Api/]
        NTests[tests/Project.Tests/]
        NControllers[Controllers/]
        NServices[Services/]

        NSrc -.-> NTests
        NTests --> NControllers
        NTests --> NServices
    end

    subgraph Python["Python (tests/ folder)"]
        PSrc[src/]
        PTests[tests/]
        PUnit[unit/]
        PInt[integration/]
        PConftest[conftest.py]

        PSrc -.-> PTests
        PTests --> PUnit
        PTests --> PInt
        PTests --> PConftest
    end
    </div>

    <footer>
        <p>ln-743-test-infrastructure v2.0.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
