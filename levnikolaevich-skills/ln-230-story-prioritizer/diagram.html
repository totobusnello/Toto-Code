<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-230-story-prioritizer Workflow</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'base',
            themeVariables: {
                primaryColor: '#4A90E2',
                primaryTextColor: '#fff',
                primaryBorderColor: '#2E5C8A',
                lineColor: '#5C6BC0',
                secondaryColor: '#7E57C2',
                tertiaryColor: '#26A69A'
            }
        });
    </script>
</head>
<body>
    <div class="container">
        <h1>ln-230-story-prioritizer: Story Prioritizer (L2 Worker)</h1>

        <div class="diagram-section">
            <h2>Workflow Diagram</h2>
            <div class="mermaid">
graph TD
    Start([Input: Epic ID]) --> Phase1[Phase 1: Discovery]

    Phase1 --> ValidateEpic[Validate Epic in Linear<br/>get_project]
    ValidateEpic --> AutoDiscover[Auto-discover Team ID<br/>from kanban_board.md]
    AutoDiscover --> CheckExisting{Existing<br/>prioritization.md?}
    CheckExisting -->|Yes| AskUpdate{Update or<br/>Create new?}
    CheckExisting -->|No| CreateDir[Create output directory<br/>docs/market/epic-slug/]
    AskUpdate -->|Update| CreateDir
    AskUpdate -->|New| CreateDir

    CreateDir --> Phase2[Phase 2: Load Stories Metadata]
    Phase2 --> QueryStories[list_issues<br/>project=Epic.id, label=user-story]
    QueryStories --> ExtractMeta[Extract metadata only<br/>ID, title, status<br/>~50 tokens/Story]
    ExtractMeta --> FilterStories[Filter: Exclude Done/Cancelled]
    FilterStories --> BuildQueue[Build processing queue<br/>N Stories]

    BuildQueue --> Phase3[Phase 3: Story-by-Story Loop]
    Phase3 --> LoopStart{Stories<br/>remaining?}
    LoopStart -->|No| Phase4[Phase 4: Generate Table]
    LoopStart -->|Yes| LoadStory[Step 3.1: Load Story<br/>get_issue - full description]

    LoadStory --> ExtractProblem[Extract Customer Problem<br/>from So that + Context]
    ExtractProblem --> ResearchMarket[Step 3.2: Research Market<br/>WebSearch: market size TAM]
    ResearchMarket --> ResearchComp[Step 3.3: Research Competition<br/>WebSearch: competitors]
    ResearchComp --> CalcRICE[Step 3.4: Calculate RICE<br/>Reach x Impact x Confidence / Effort]
    CalcRICE --> AssignPriority[Step 3.5: Assign Priority<br/>P0/P1/P2/P3]
    AssignPriority --> StoreResult[Step 3.6: Store row<br/>Clear Story from context]
    StoreResult --> LoopStart

    Phase4 --> SortResults[Sort by Priority, RICE desc]
    SortResults --> GenerateMD[Generate Markdown table<br/>from template]
    GenerateMD --> SaveFile[Write to<br/>docs/market/epic-slug/prioritization.md]

    SaveFile --> Phase5[Phase 5: Summary]
    Phase5 --> DisplaySummary[Display:<br/>- Priority distribution<br/>- Top 3 priorities<br/>- Next steps]
    DisplaySummary --> End([Output: prioritization.md])

    style Start fill:#4A90E2,stroke:#2E5C8A,color:#fff
    style End fill:#26A69A,stroke:#1B5E20,color:#fff
    style Phase1 fill:#7E57C2,stroke:#4A148C,color:#fff
    style Phase2 fill:#7E57C2,stroke:#4A148C,color:#fff
    style Phase3 fill:#7E57C2,stroke:#4A148C,color:#fff
    style Phase4 fill:#7E57C2,stroke:#4A148C,color:#fff
    style Phase5 fill:#7E57C2,stroke:#4A148C,color:#fff
    style CheckExisting fill:#FF9800,stroke:#E65100,color:#fff
    style AskUpdate fill:#FF9800,stroke:#E65100,color:#fff
    style LoopStart fill:#FF9800,stroke:#E65100,color:#fff
    style CalcRICE fill:#E91E63,stroke:#880E4F,color:#fff
    style AssignPriority fill:#E91E63,stroke:#880E4F,color:#fff
            </div>
        </div>

        <div class="info-section">
            <h2>Key Information</h2>
            <ul>
                <li><strong>Type:</strong> L2 Worker (standalone)</li>
                <li><strong>Phases:</strong> 5 (with Story-by-Story loop in Phase 3)</li>
                <li><strong>Input:</strong> Epic ID or "Epic N" format</li>
                <li><strong>Output:</strong> docs/market/[epic-slug]/prioritization.md</li>
                <li><strong>Time-box:</strong> 40-60 minutes (5-10 Stories)</li>
                <li><strong>Token efficiency:</strong> ONE Story at a time (~5,000 tokens/Story)</li>
                <li><strong>Position:</strong> After ln-220, before ln-310</li>
            </ul>
        </div>

        <div class="tools-section">
            <h2>Tools Used</h2>
            <ul>
                <li><code>mcp__linear-server__get_project()</code> - Load Epic metadata</li>
                <li><code>mcp__linear-server__list_issues()</code> - Get Stories in Epic</li>
                <li><code>mcp__linear-server__get_issue()</code> - Load Story description (per-Story)</li>
                <li><code>WebSearch</code> - Market size and competition research</li>
                <li><code>mcp__Ref__ref_search_documentation()</code> - Industry reports</li>
                <li><code>Glob</code> - Check existing prioritization.md</li>
                <li><code>Write</code> - Save output file</li>
            </ul>
        </div>

        <div class="notes-section">
            <h2>RICE Scoring</h2>
            <ul>
                <li><strong>RICE =</strong> (Reach x Impact x Confidence) / Effort</li>
                <li><strong>Reach:</strong> 1-10 (users affected per quarter)</li>
                <li><strong>Impact:</strong> 0.25-3.0 (Minimal to Massive)</li>
                <li><strong>Confidence:</strong> 0.5-1.0 (data quality)</li>
                <li><strong>Effort:</strong> 1-10 (person-months)</li>
            </ul>
        </div>

        <div class="notes-section">
            <h2>Priority Mapping</h2>
            <ul>
                <li><strong>P0 (Critical):</strong> RICE >= 30 OR Competition = 1 (Blue Ocean)</li>
                <li><strong>P1 (High):</strong> RICE >= 15 OR Competition <= 2</li>
                <li><strong>P2 (Medium):</strong> RICE >= 5</li>
                <li><strong>P3 (Low):</strong> RICE < 5</li>
            </ul>
        </div>

        <div class="notes-section">
            <h2>Competition Index</h2>
            <ul>
                <li><strong>1 (Blue Ocean):</strong> 0 competitors</li>
                <li><strong>2 (Emerging):</strong> 1-2 competitors</li>
                <li><strong>3 (Growing):</strong> 3-5 competitors</li>
                <li><strong>4 (Mature):</strong> 6-10 competitors</li>
                <li><strong>5 (Red Ocean):</strong> >10 competitors</li>
            </ul>
        </div>
    </div>
</body>
</html>
