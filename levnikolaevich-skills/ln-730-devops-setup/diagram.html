<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-730-devops-setup - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-730-devops-setup</h1>
    <p>L2 Domain Coordinator - Orchestrates DevOps infrastructure setup with auto-detection</p>

    <h2>Main Workflow (5 Phases)</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> PreFlight: Start DevOps Setup

    state PreFlight {
        [*] --> CheckDocker
        CheckDocker --> CheckCompose: Docker OK
        CheckCompose --> CheckExisting: Compose OK
        CheckExisting --> [*]: Ready
        CheckDocker --> STOP: Docker Missing
        CheckCompose --> STOP: Compose Missing
    }

    PreFlight --> AutoDetect: Validation Passed
    PreFlight --> [*]: STOP (Missing Tools)

    state AutoDetect {
        [*] --> DetectFrontend
        DetectFrontend --> DetectBackend
        DetectBackend --> DetectVersions
        DetectVersions --> [*]
    }

    AutoDetect --> Delegate: Stack Detected

    state Delegate {
        [*] --> Workers
        Workers --> [*]

        state Workers {
            ln731: ln-731 Docker
            ln732: ln-732 CI/CD
            ln733: ln-733 Env
        }
    }

    Delegate --> Verify: Workers Complete

    state Verify {
        [*] --> ValidateCompose
        ValidateCompose --> CheckFiles
        CheckFiles --> CheckSecrets
        CheckSecrets --> [*]
    }

    Verify --> Report: Verified
    Report --> [*]: Complete
    </div>

    <h2>Auto-Detection Logic</h2>
    <div class="mermaid">
flowchart TB
    Start([Start Detection]) --> Frontend

    subgraph Frontend["Frontend Detection"]
        F1{package.json?}
        F1 -->|Yes| F2{React/Vite?}
        F1 -->|No| F3[No Frontend]
        F2 -->|Yes| F4[React + Nginx]
        F2 -->|No| F3
    end

    Frontend --> Backend

    subgraph Backend["Backend Detection"]
        B1{.sln/.csproj?}
        B1 -->|Yes| B2[.NET Backend]
        B1 -->|No| B3{requirements.txt?}
        B3 -->|Yes| B4[Python Backend]
        B3 -->|No| B5[No Backend]
    end

    Backend --> Database

    subgraph Database["Database Detection"]
        D1{ConnectionString?}
        D1 -->|PostgreSQL| D2[PostgreSQL]
        D1 -->|None| D3[No Database]
    end

    Database --> Config([Stack Config])

    classDef detect fill:#E3F2FD
    classDef result fill:#C8E6C9
    class F1,F2,B1,B3,D1 detect
    class F4,B2,B4,D2,Config result
    </div>

    <h2>Worker Delegation (Parallel)</h2>
    <div class="mermaid">
sequenceDiagram
    participant C as ln-730 Coordinator
    participant D as ln-731 Docker
    participant CI as ln-732 CI/CD
    participant E as ln-733 Env

    Note over C: Phase 1: Pre-flight
    C->>C: Check Docker, Compose

    Note over C: Phase 2: Auto-detect
    C->>C: Detect Stack & Versions

    rect rgb(200, 230, 200)
        Note over C,E: Phase 3: Parallel Delegation
        par Docker Generation
            C->>+D: Generate (stack, versions)
            D->>D: Dockerfile.frontend
            D->>D: Dockerfile.backend
            D->>D: docker-compose.yml
            D->>D: .dockerignore
            D-->>-C: Files Ready
        and CI/CD Generation
            C->>+CI: Generate (stack, commands)
            CI->>CI: .github/workflows/ci.yml
            CI-->>-C: Workflow Ready
        and Environment Setup
            C->>+E: Configure (env vars)
            E->>E: .env.example
            E->>E: .env.development
            E->>E: .gitignore updates
            E-->>-C: Env Ready
        end
    end

    Note over C: Phase 4: Verify
    C->>C: docker-compose config
    C->>C: Check files exist
    C->>C: Scan for secrets

    Note over C: Phase 5: Report
    C->>C: Generate summary
    </div>

    <h2>Error Handling</h2>
    <div class="mermaid">
flowchart LR
    subgraph Workers["Worker Execution"]
        W1[ln-731]
        W2[ln-732]
        W3[ln-733]
    end

    W1 -->|Success| S1[Docker Files]
    W1 -->|Fail| E1[Log Error]

    W2 -->|Success| S2[CI/CD Files]
    W2 -->|Fail| E2[Log Error]

    W3 -->|Success| S3[Env Files]
    W3 -->|Fail| E3[Log Error]

    S1 & S2 & S3 --> Report([Completion Report])
    E1 & E2 & E3 --> Report

    Report --> Next{All Success?}
    Next -->|Yes| Done([Done])
    Next -->|No| Manual([Manual Fix Suggestions])

    classDef success fill:#C8E6C9
    classDef error fill:#FFCDD2
    classDef report fill:#E3F2FD
    class S1,S2,S3 success
    class E1,E2,E3 error
    class Report,Done,Manual report
    </div>

    <footer>
        <p>ln-730-devops-setup v1.1.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
