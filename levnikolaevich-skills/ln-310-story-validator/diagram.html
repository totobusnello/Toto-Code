<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-310-story-validator - State Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="../shared/css/diagram.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ln-310-story-validator</h1>
            <p class="subtitle">Story Validator with Penalty Points - State Diagram</p>
        </header>
        <div class="info-box">
            <h3>Overview</h3>
            <ul>
                <li><strong>Purpose:</strong> Validate and auto-fix Stories/Tasks against 2025 standards</li>
                <li><strong>Goal:</strong> Penalty Points = 0 after all fixes applied</li>
                <li><strong>Plan Mode:</strong> Phase 3 waits for user approval before fixing</li>
                <li><strong>Delegation:</strong> ln-002 creates guides/manuals/ADRs/research in Phase 2</li>
            </ul>
        </div>
        <div class="diagram-container">
            <div class="mermaid">
graph TD
    Start([Start: Validate Story]) --> Phase1

    subgraph Phase1 [Phase 1: Discovery & Loading]
        P1A[Auto-discover config<br/>Team ID from kanban_board.md]
        P1A --> P1B[Load Story metadata<br/>ID, title, status, labels]
        P1B --> P1C[Load Tasks metadata<br/>3-8 implementation tasks expected]
    end

    Phase1 --> Phase2

    subgraph Phase2 [Phase 2: Research & Audit]
        P2A[Domain Extraction<br/>Scan Story for patterns]
        P2A --> P2B{Patterns<br/>detected?}
        P2B -->|Yes| P2C[Delegate to ln-002<br/>Create guides/manuals/ADRs/research]
        P2B -->|No| P2D[MCP Ref fallback<br/>Query standards directly]
        P2C --> P2E[Calculate Penalty Points<br/>17 criteria evaluation]
        P2D --> P2E
        P2E --> P2F[Build Fix Plan<br/>List violations + fixes]
    end

    Phase2 --> Phase3

    subgraph Phase3 [Phase 3: Audit Results & Fix Plan]
        P3A[Display Penalty Points table<br/>Criterion | Severity | Points]
        P3A --> P3B{Plan Mode<br/>active?}
        P3B -->|Yes| P3C[WAIT for user approval<br/>Show fix plan]
        P3B -->|No| P3D[Proceed immediately]
        P3C --> P3D
    end

    Phase3 --> Phase4

    subgraph Phase4 [Phase 4: Auto-Fix 17 Criteria in 6 Groups]
        P4A[Group 1: Structural #1-#4<br/>Story + Tasks structure]
        P4A --> P4B[Group 2: Standards #5<br/>RFC/OWASP compliance FIRST]
        P4B --> P4C[Group 3: Solution #6<br/>Library versions]
        P4C --> P4D[Group 4: Workflow #7-#13<br/>Test Strategy, Docs, Size<br/>YAGNI, KISS, Task Order]
        P4D --> P4E[Group 5: Quality #14-#15<br/>Docs complete, No hardcoded]
        P4E --> P4F[Group 6: Traceability #16-#17<br/>Story-Task align, AC coverage]
        P4F --> P4G[Penalty Points = 0]
    end

    Phase4 --> Phase5

    subgraph Phase5 [Phase 5: Approve & Notify]
        P5A[Story + Tasks -> Todo<br/>Update Linear status]
        P5A --> P5B[Update kanban_board.md<br/>Add APPROVED marker]
        P5B --> P5C[Add Linear comment<br/>Penalty table + fixes + docs]
        P5C --> P5D[Display summary table<br/>Before -> 0 After]
    end

    Phase5 --> End([End: Story Approved<br/>Penalty Points = 0])

    classDef discovery fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef research fill:#FFF3E0,stroke:#E65100,stroke-width:2px
    classDef decision fill:#FFF9C4,stroke:#F57C00,stroke-width:2px
    classDef fix fill:#E8F5E9,stroke:#388E3C,stroke-width:2px
    classDef approve fill:#C8E6C9,stroke:#2E7D32,stroke-width:2px

    class P1A,P1B,P1C discovery
    class P2A,P2B,P2C,P2D,P2E,P2F research
    class P3A,P3B,P3C,P3D decision
    class P4A,P4B,P4C,P4D,P4E,P4F,P4G fix
    class P5A,P5B,P5C,P5D approve
            </div>
        </div>
        <div class="info-box">
            <h3>Penalty Points System</h3>
            <table style="width:100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="background: #f5f5f5;">
                    <th style="padding: 8px; border: 1px solid #ddd;">Severity</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Points</th>
                    <th style="padding: 8px; border: 1px solid #ddd;">Description</th>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; color: #d32f2f; font-weight: bold;">CRITICAL</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">10</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">RFC/OWASP/Security violations</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; color: #f57c00; font-weight: bold;">HIGH</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">5</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">Outdated libraries, architecture issues</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; color: #fbc02d; font-weight: bold;">MEDIUM</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">3</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">Best practices violations</td>
                </tr>
                <tr>
                    <td style="padding: 8px; border: 1px solid #ddd; color: #388e3c; font-weight: bold;">LOW</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">1</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">Structural/cosmetic issues</td>
                </tr>
            </table>
        </div>
        <footer>
            <p>ln-310-story-validator v5.0.0 | 5 phases | 17 criteria (6 groups) | Penalty Points system | Plan Mode support</p>
        </footer>
    </div>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default', flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' } });
    </script>
</body>
</html>
