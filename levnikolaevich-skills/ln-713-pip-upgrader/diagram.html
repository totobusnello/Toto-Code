<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-713-pip-upgrader - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-713-pip-upgrader</h1>
    <p>L3 Worker - Upgrades Python pip/poetry/pipenv dependencies</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> DetectManager: Start

    DetectManager --> SecurityAudit: Manager Detected
    SecurityAudit --> CheckOutdated: Audit Pass
    SecurityAudit --> Report: Critical CVE Found

    CheckOutdated --> ApplyUpgrades: Outdated Found
    CheckOutdated --> Report: All Up-to-date

    ApplyUpgrades --> Verify: Packages Updated

    Verify --> Report: Tests Pass
    Verify --> Rollback: Tests Fail

    Rollback --> ApplyUpgrades: Retry Next Package

    Report --> [*]: Complete
    </div>

    <h2>Package Manager Detection</h2>
    <div class="mermaid">
flowchart TD
    Start([Receive Context]) --> CheckFiles{Check Indicator Files}

    CheckFiles --> HasPoetry{pyproject.toml + poetry.lock?}
    HasPoetry -->|Yes| UsePoetry[Use poetry]
    HasPoetry -->|No| HasPipenv

    HasPipenv{Pipfile + Pipfile.lock?}
    HasPipenv -->|Yes| UsePipenv[Use pipenv]
    HasPipenv -->|No| HasRequirements

    HasRequirements{requirements.txt?}
    HasRequirements -->|Yes| UsePip[Use pip]
    HasRequirements -->|No| NoDeps[No Dependencies Found]

    UsePoetry --> Proceed([Continue Upgrade])
    UsePipenv --> Proceed
    UsePip --> Proceed

    classDef decision fill:#FFE4B5
    classDef action fill:#90EE90
    classDef error fill:#FF6B6B
    class HasPoetry,HasPipenv,HasRequirements decision
    class UsePoetry,UsePipenv,UsePip action
    class NoDeps error
    </div>

    <h2>Commands by Manager</h2>
    <div class="mermaid">
flowchart LR
    subgraph pip
        P1[pip list --outdated]
        P2[pip install --upgrade]
        P3[pip freeze > requirements.txt]
    end

    subgraph poetry
        Po1[poetry show --outdated]
        Po2[poetry update]
        Po3[Auto-updates lock]
    end

    subgraph pipenv
        Pi1[pipenv update --outdated]
        Pi2[pipenv update]
        Pi3[Auto-updates lock]
    end
    </div>

    <h2>Verification Flow</h2>
    <div class="mermaid">
sequenceDiagram
    participant W as Worker
    participant Py as Python
    participant Ctx as Context7/Ref

    W->>Py: Import test
    Py-->>W: Import Result

    alt Import Fails
        W->>Ctx: Query breaking changes
        Ctx-->>W: Migration steps
        W->>W: Apply fixes
    end

    W->>Py: pytest
    Py-->>W: Test Results
    </div>

    <footer>
        <p>ln-713-pip-upgrader v1.1.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
