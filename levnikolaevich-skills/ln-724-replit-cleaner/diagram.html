<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-724-replit-cleaner - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-724-replit-cleaner</h1>
    <p>L3 Worker - Removes all Replit artifacts from exported projects (under ln-720-structure-migrator)</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> Scan: Start

    state Scan {
        [*] --> ConfigFiles
        ConfigFiles --> Directories
        Directories --> Packages
        Packages --> ViteConfig
        ViteConfig --> CodeComments
        CodeComments --> Gitignore
        Gitignore --> [*]
    }

    Scan --> Preview: Artifacts Found
    Scan --> Clean: No Artifacts

    state Preview {
        [*] --> ShowDeletes
        ShowDeletes --> ShowModifies
        ShowModifies --> ShowSummary
        ShowSummary --> [*]
    }

    Preview --> Confirm
    Confirm --> Execute: User Approves
    Confirm --> [*]: User Cancels

    state Execute {
        [*] --> DeleteFiles
        DeleteFiles --> DeleteDirs
        DeleteDirs --> ModifyPackageJson
        ModifyPackageJson --> ModifyViteConfig
        ModifyViteConfig --> RemoveComments
        RemoveComments --> ModifyGitignore
        ModifyGitignore --> [*]
    }

    Execute --> Report
    Clean --> Report: Already Clean

    Report --> [*]: Complete
    </div>

    <h2>Artifact Detection Flow</h2>
    <div class="mermaid">
flowchart TD
    Start([Start Scan]) --> ConfigFiles{Config Files?}

    ConfigFiles -->|.replit, replit.nix| Found1[Add to DELETE list]
    ConfigFiles -->|Not Found| Dirs

    Found1 --> Dirs{Directories?}
    Dirs -->|.local/, .cache/| Found2[Add to DELETE list]
    Dirs -->|Not Found| Packages

    Found2 --> Packages{NPM Packages?}
    Packages -->|@replit/*| Found3[Add to MODIFY list]
    Packages -->|Not Found| ViteConfig

    Found3 --> ViteConfig{Vite Config?}
    ViteConfig -->|Imports, REPL_ID| Found4[Add to MODIFY list]
    ViteConfig -->|Not Found| Comments

    Found4 --> Comments{Code Comments?}
    Comments -->|// @replit| Found5[Add to MODIFY list]
    Comments -->|Not Found| Gitignore

    Found5 --> Gitignore{.gitignore?}
    Gitignore -->|.replit entry| Found6[Add to MODIFY list]
    Gitignore -->|Not Found| Summary

    Found6 --> Summary([Generate Summary])

    classDef delete fill:#FFCCCB
    classDef modify fill:#FFFFCC
    classDef scan fill:#90EE90
    class Found1,Found2 delete
    class Found3,Found4,Found5,Found6 modify
    class Start,Summary scan
    </div>

    <h2>Execute Phase Details</h2>
    <div class="mermaid">
sequenceDiagram
    participant C as ln-724-replit-cleaner
    participant FS as File System
    participant JSON as JSON Parser
    participant AST as Code Parser

    Note over C: Phase 4.1 - Delete Files
    C->>FS: rm .replit, replit.nix
    C->>FS: rm vite-plugin-meta-images.ts
    C->>FS: rm -rf .local/, .cache/

    Note over C: Phase 4.2 - Modify package.json
    C->>FS: Read package.json
    FS-->>C: JSON content
    C->>JSON: Parse and filter @replit/*
    JSON-->>C: Cleaned JSON
    C->>FS: Write package.json

    Note over C: Phase 4.3 - Modify vite.config.ts
    C->>FS: Read vite.config.ts
    FS-->>C: TypeScript content
    C->>AST: Remove imports and plugins
    AST-->>C: Cleaned config
    C->>FS: Write vite.config.ts

    Note over C: Phase 4.4 - Remove Comments
    loop For each *.tsx file
        C->>FS: Read file
        C->>AST: Remove // @replit lines
        C->>FS: Write file
    end

    Note over C: Phase 4.5 - Modify .gitignore
    C->>FS: Read .gitignore
    C->>AST: Remove .replit line
    C->>FS: Write .gitignore

    C-->>C: Generate Report
    </div>

    <h2>Integration with ln-720-structure-migrator</h2>
    <div class="mermaid">
flowchart LR
    subgraph ln-720[ln-720-structure-migrator]
        P1[Phase 1: Detect]
        P2[Phase 2: Clean Replit]
        P3[Phase 3: Restructure]
        P4[Phase 4: Generate Backend]
        P5[Phase 5: Migrate Data]
    end

    P1 --> P2
    P2 --> P3
    P3 --> P4
    P4 --> P5

    P2 -.-> Clean([ln-724-replit-cleaner])
    P3 -.-> Frontend([ln-721-frontend-restructure])
    P4 -.-> Backend([ln-722-backend-generator])
    P5 -.-> Mockdata([ln-723-mockdata-migrator])

    classDef cleaner fill:#E6E6FA
    classDef worker fill:#90EE90
    class Clean cleaner
    class Frontend,Backend,Mockdata worker
    </div>

    <footer>
        <p>ln-724-replit-cleaner v1.0.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
