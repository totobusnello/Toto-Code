<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-360-codebase-auditor Workflow</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
    <link rel="stylesheet" href="../shared/css/diagram.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>ln-360-codebase-auditor Workflow</h1>
            <p class="subtitle">L2 Coordinator v4.0.0 | Domain-Aware Audit</p>
        </header>
        <div class="info-box">
        <h3>Overview</h3>
        <p><strong>Purpose:</strong> Coordinates 9 specialized audit workers with domain-aware scanning for Architecture and Code Quality.</p>
        <p><strong>Type:</strong> Orchestrator-Worker Pattern (L2 Coordinator + 9 L3 Workers)</p>
        <p><strong>Domain Support:</strong> Auto-detects project domains; runs Architecture (ln-363) and Code Quality (ln-364) per domain.</p>
        <p><strong>Invocation:</strong> Manual - user runs when needed for technical debt assessment.</p>
    </div>

    <h2>Main Workflow (8 Phases)</h2>

    <div class="mermaid">
graph TD
    Start([START]) --> Phase1[Phase 1: Discovery<br/>Load tech_stack.md<br/>Load principles.md<br/>Auto-discover Team ID]

    Phase1 --> Phase2[Phase 2: Research<br/>MCP Ref + Context7<br/>Best practices ONCE<br/>Build contextStore]

    Phase2 --> Phase3[Phase 3: Domain Discovery<br/>Detect project structure<br/>Build domain_map<br/>Set domain_mode]

    Phase3 --> Decision{Domains<br/>found?}

    Decision -->|Yes domain-aware| Phase4a
    Decision -->|No global| Phase4aGlobal[Phase 4a: Global Workers<br/>7 workers PARALLEL<br/>Entire codebase]

    Phase4a[Phase 4a: Global Workers<br/>7 workers PARALLEL<br/>Entire codebase] --> Phase4b[Phase 4b: Domain-Aware<br/>ln-363 + ln-364<br/>per domain PARALLEL]

    Phase4aGlobal --> Phase4bGlobal[Phase 4b: Domain-Aware<br/>ln-363 + ln-364<br/>global mode]

    Phase4b --> Phase5[Phase 5: Aggregate<br/>Group by domain<br/>Domain Health Summary<br/>Calculate scores]

    Phase4bGlobal --> Phase5

    Phase5 --> Phase6[Phase 6: Generate Report<br/>Executive Summary<br/>Domain-grouped findings<br/>Recommended Actions]

    Phase6 --> Phase7[Phase 7: Create Task<br/>Linear Epic 0<br/>Full report]

    Phase7 --> End([END:<br/>Refactoring task created])

    classDef phase fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef newphase fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px
    classDef decision fill:#FFF3E0,stroke:#FF9800,stroke-width:2px
    classDef endpoint fill:#C8E6C9,stroke:#388E3C,stroke-width:2px

    class Phase1,Phase2,Phase4a,Phase4aGlobal,Phase5,Phase6,Phase7 phase
    class Phase3,Phase4b,Phase4bGlobal newphase
    class Decision decision
    class Start,End endpoint
    </div>

    <h2>Worker Distribution</h2>

    <div class="mermaid">
graph TB
    subgraph Coordinator["ln-360-codebase-auditor (L2)"]
        direction TB
        Coord[Orchestrator<br/>Domain Discovery<br/>Context Building<br/>Aggregation]
    end

    subgraph GlobalWorkers["Global Workers (7) - Entire Codebase"]
        direction LR
        W1[ln-361<br/>Security<br/>CRITICAL]
        W2[ln-362<br/>Build<br/>CRITICAL]
        W5[ln-365<br/>Dependencies<br/>MEDIUM]
        W6[ln-366<br/>Dead Code<br/>LOW]
        W7[ln-367<br/>Observability<br/>MEDIUM]
        W8[ln-368<br/>Concurrency<br/>HIGH]
        W9[ln-369<br/>Lifecycle<br/>MEDIUM]
    end

    subgraph DomainWorkers["Domain-Aware Workers (2 × N) - Per Domain"]
        direction TB
        subgraph DomainUsers["Domain: users"]
            W3u[ln-363<br/>Architecture]
            W4u[ln-364<br/>Code Quality]
        end
        subgraph DomainOrders["Domain: orders"]
            W3o[ln-363<br/>Architecture]
            W4o[ln-364<br/>Code Quality]
        end
        subgraph DomainPayments["Domain: payments"]
            W3p[ln-363<br/>Architecture]
            W4p[ln-364<br/>Code Quality]
        end
    end

    Coord --> GlobalWorkers
    Coord --> DomainWorkers

    classDef coordinator fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef critical fill:#FFCDD2,stroke:#D32F2F,stroke-width:2px
    classDef high fill:#FFE0B2,stroke:#F57C00,stroke-width:2px
    classDef medium fill:#FFF9C4,stroke:#FBC02D,stroke-width:2px
    classDef low fill:#C8E6C9,stroke:#388E3C,stroke-width:2px
    classDef domain fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px

    class Coord coordinator
    class W1,W2 critical
    class W8 high
    class W5,W7,W9 medium
    class W6 low
    class W3u,W4u,W3o,W4o,W3p,W4p domain
    </div>

    <h2>Domain Discovery Algorithm</h2>

    <div class="mermaid">
graph TD
    Start2([Check Structure]) --> P1{Priority 1:<br/>Explicit domains?}
    P1 -->|Found| UseExplicit[Use domains/features/modules]
    P1 -->|Not found| P2{Priority 2:<br/>src/* folders?}
    P2 -->|Found >1| FilterInfra[Filter infrastructure<br/>utils/shared/config/types]
    P2 -->|Not found| P3[Priority 3:<br/>Fallback to global]
    FilterInfra --> HasDomains{Remaining<br/>>1 folders?}
    HasDomains -->|Yes| UseSrc[Use src/* as domains]
    HasDomains -->|No| P3
    UseExplicit --> DomainAware([domain_mode = domain-aware])
    UseSrc --> DomainAware
    P3 --> GlobalMode([domain_mode = global])

    classDef decision fill:#FFF3E0,stroke:#FF9800,stroke-width:2px
    classDef process fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
    classDef result fill:#E8F5E9,stroke:#4CAF50,stroke-width:2px

    class P1,P2,HasDomains decision
    class UseExplicit,FilterInfra,UseSrc,P3 process
    class DomainAware,GlobalMode,Start2 result
    </div>

    <h2>Output: Report with Domain Health Summary</h2>
    <pre style="background: #F5F5F5; padding: 15px; border-radius: 4px; overflow-x: auto;">
## Codebase Audit Report - 2025-12-22

### Compliance Score
| Category | Score |
|----------|-------|
| Security | 8/10 |
| Build Health | 9/10 |
| Architecture | 6.5/10 |
| Code Quality | 7.5/10 |
| ... | ... |
| **Overall** | **7.3/10** |

### Domain Health Summary (NEW)
| Domain | Files | Arch | Quality | Issues |
|--------|-------|------|---------|--------|
| users | 45 | 7/10 | 8/10 | 5 |
| orders | 32 | 5/10 | 6/10 | 8 |
| shared | 15 | 8/10 | 9/10 | 2 |

### Findings by Category
#### 3. Architecture (Domain-Grouped)
##### Domain: users
| Severity | Location | Issue |
| CRITICAL | UserController.ts:12 | Controller→Repository bypass |

##### Domain: orders
| Severity | Location | Issue |
| HIGH | OrderService.ts:45 | DRY violation |
    </pre>

    <h2>Key Characteristics</h2>
    <ul>
        <li><strong>Orchestrator-Worker:</strong> L2 Coordinator + 9 L3 Workers</li>
        <li><strong>Domain-Aware:</strong> Architecture (ln-363) and Code Quality (ln-364) run per domain</li>
        <li><strong>Global Workers:</strong> Security, Build, Dependencies, Dead Code, Observability, Concurrency, Lifecycle</li>
        <li><strong>Parallel Execution:</strong> All workers (global + domain-aware) run in PARALLEL</li>
        <li><strong>Domain Health Summary:</strong> Per-domain scores for focused improvement</li>
        <li><strong>Backward Compatible:</strong> Falls back to global mode if <2 domains detected</li>
    </ul>

    <footer>
        <p>ln-360-codebase-auditor v4.0.0 | L2 Coordinator | 9 Workers | Domain-Aware Audit</p>
    </footer>
    </div>
    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default', flowchart: { useMaxWidth: true, htmlLabels: true, curve: 'basis' } });
    </script>
</body>
</html>
