<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-774-healthcheck-setup - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-774-healthcheck-setup</h1>
    <p>L3 Worker - Configures health check endpoints for Kubernetes probes</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> ReceiveContext: Start

    ReceiveContext --> IdempotencyCheck: Context Valid
    IdempotencyCheck --> Skip: Health Checks Exist
    IdempotencyCheck --> DetectDeps: Not Configured

    DetectDeps --> Research: Dependencies Identified
    Research --> ConfigureProbes: Patterns Loaded
    ConfigureProbes --> Generate: Probes Configured
    Generate --> Validate: Files Generated
    Validate --> Return: Success

    Skip --> Return: Status = skipped
    Return --> [*]: Complete

    state DetectDeps {
        [*] --> ScanDB
        ScanDB --> ScanRedis
        ScanRedis --> ScanQueue
        ScanQueue --> [*]
    }
    </div>

    <h2>Kubernetes Probes Architecture</h2>
    <div class="mermaid">
flowchart TD
    Kubelet([Kubelet]) --> Probes{Probe Type}

    Probes -->|Startup| Startup[/health/startup]
    Probes -->|Liveness| Live[/health/live]
    Probes -->|Readiness| Ready[/health/ready]

    Startup --> StartupCheck{App Initialized?}
    StartupCheck -->|Yes| EnableOther[Enable Other Probes]
    StartupCheck -->|No| Wait[Wait & Retry]

    Live --> LiveCheck{App Running?}
    LiveCheck -->|200 OK| Healthy1[Container Healthy]
    LiveCheck -->|503| Restart[Restart Container]

    Ready --> ReadyCheck{Dependencies OK?}
    ReadyCheck -->|200 OK| Healthy2[Accept Traffic]
    ReadyCheck -->|503| RemoveTraffic[Remove from Service]

    classDef healthy fill:#90EE90
    classDef unhealthy fill:#FFB6C1
    classDef probe fill:#87CEEB
    class Healthy1,Healthy2,EnableOther healthy
    class Restart,RemoveTraffic unhealthy
    class Startup,Live,Ready probe
    </div>

    <h2>Health Check Endpoint Types</h2>
    <div class="mermaid">
flowchart LR
    subgraph Liveness["/health/live"]
        LiveDesc["Purpose: Is app alive?"]
        LiveChecks["Checks: None (just responds)"]
        LiveFail["On Fail: Container restart"]
    end

    subgraph Readiness["/health/ready"]
        ReadyDesc["Purpose: Can serve traffic?"]
        ReadyChecks["Checks: DB, Redis, APIs"]
        ReadyFail["On Fail: Remove from service"]
    end

    subgraph StartupP["/health/startup"]
        StartupDesc["Purpose: App initialized?"]
        StartupChecks["Checks: Initial warmup"]
        StartupFail["On Fail: Delay other probes"]
    end

    classDef live fill:#90EE90
    classDef ready fill:#87CEEB
    classDef startup fill:#FFE4B5
    class Liveness live
    class Readiness ready
    class StartupP startup
    </div>

    <h2>Dependency Health Checks</h2>
    <div class="mermaid">
flowchart TD
    Ready[/health/ready] --> Check{Check Dependencies}

    Check --> DB[(Database)]
    Check --> Redis[(Redis)]
    Check --> Queue[(Message Queue)]
    Check --> API[External API]

    DB --> DBStatus{PostgreSQL OK?}
    Redis --> RedisStatus{Redis OK?}
    Queue --> QueueStatus{RabbitMQ OK?}
    API --> APIStatus{API OK?}

    DBStatus --> Aggregate{All Healthy?}
    RedisStatus --> Aggregate
    QueueStatus --> Aggregate
    APIStatus --> Aggregate

    Aggregate -->|Yes| OK[200 OK + JSON]
    Aggregate -->|No| Fail[503 + Failed Checks]

    classDef healthy fill:#90EE90
    classDef unhealthy fill:#FFB6C1
    class OK healthy
    class Fail unhealthy
    </div>

    <h2>Probe Timing Configuration</h2>
    <div class="mermaid">
flowchart LR
    subgraph LiveTiming["Liveness Timing"]
        L1["initialDelaySeconds: 10"]
        L2["periodSeconds: 10"]
        L3["timeoutSeconds: 5"]
        L4["failureThreshold: 3"]
    end

    subgraph ReadyTiming["Readiness Timing"]
        R1["initialDelaySeconds: 5"]
        R2["periodSeconds: 5"]
        R3["timeoutSeconds: 3"]
        R4["failureThreshold: 3"]
    end

    subgraph StartupTiming["Startup Timing"]
        S1["initialDelaySeconds: 0"]
        S2["periodSeconds: 5"]
        S3["failureThreshold: 30"]
        S4["Max: 150 seconds"]
    end

    classDef timing fill:#FFD700
    class L1,L2,L3,L4,R1,R2,R3,R4,S1,S2,S3,S4 timing
    </div>

    <footer>
        <p>ln-774-healthcheck-setup v2.0.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
