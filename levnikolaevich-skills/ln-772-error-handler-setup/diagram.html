<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ln-772-error-handler-setup - Workflow Diagram</title>
    <link rel="stylesheet" href="../shared/css/diagram.css">
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script>mermaid.initialize({startOnLoad: true, theme: 'default'});</script>
</head>
<body>
    <h1>ln-772-error-handler-setup</h1>
    <p>L3 Worker - Configures global exception handling middleware</p>

    <h2>Main Workflow</h2>
    <div class="mermaid">
stateDiagram-v2
    [*] --> ReceiveContext: Start

    ReceiveContext --> IdempotencyCheck: Context Valid
    IdempotencyCheck --> Skip: Already Configured
    IdempotencyCheck --> Research: Not Configured

    Research --> DecisionPoints: Patterns Loaded
    DecisionPoints --> Generate: Decisions Made
    Generate --> Validate: Files Generated
    Validate --> Return: Success

    Skip --> Return: Status = skipped
    Return --> [*]: Complete
    </div>

    <h2>Exception Handling Pipeline</h2>
    <div class="mermaid">
flowchart TD
    Request([Incoming Request]) --> Controller[Controller/Handler]

    Controller --> Try{Try Execute}

    Try -->|Success| Response([Normal Response])

    Try -->|Exception| Catch[Global Exception Middleware]

    Catch --> Classify{Exception Type?}

    Classify -->|ValidationException| E400[400 Bad Request]
    Classify -->|UnauthorizedException| E401[401 Unauthorized]
    Classify -->|ForbiddenException| E403[403 Forbidden]
    Classify -->|NotFoundException| E404[404 Not Found]
    Classify -->|ConflictException| E409[409 Conflict]
    Classify -->|Other| E500[500 Internal Error]

    E400 --> Log[Log Exception]
    E401 --> Log
    E403 --> Log
    E404 --> Log
    E409 --> Log
    E500 --> Log

    Log --> Format[Format Error Response]
    Format --> ErrorResponse([Error Response])

    classDef error fill:#FFB6C1
    classDef success fill:#90EE90
    class E400,E401,E403,E404,E409,E500 error
    class Response success
    </div>

    <h2>Error Response Format (ProblemDetails RFC 7807)</h2>
    <div class="mermaid">
flowchart LR
    Exception([Exception]) --> Handler[Error Handler]

    Handler --> Response[ProblemDetails Response]

    subgraph Response["Error Response Structure"]
        type["type: RFC URL"]
        title["title: Error Title"]
        status["status: HTTP Code"]
        detail["detail: Description"]
        instance["instance: Request Path"]
        errors["errors: Field Errors"]
        traceId["traceId: Correlation ID"]
    end

    Response --> JSON[JSON Output]

    classDef field fill:#FFD700
    class type,title,status,detail,instance,errors,traceId field
    </div>

    <h2>Environment-Based Detail Level</h2>
    <div class="mermaid">
flowchart TD
    Exception([Exception Caught]) --> Env{Environment?}

    Env -->|Development| DevResponse[Full Details]
    Env -->|Production| ProdResponse[Safe Details]

    subgraph DevResponse["Development Response"]
        StackTrace["Stack Trace: ✓ Show"]
        InnerException["Inner Exceptions: ✓ Show"]
        RequestDetails["Request Details: ✓ Show"]
    end

    subgraph ProdResponse["Production Response"]
        NoStackTrace["Stack Trace: ✗ Hidden"]
        NoInnerException["Inner Exceptions: ✗ Hidden"]
        NoRequestDetails["Request Details: ✗ Hidden"]
        GenericMessage["Generic Message: User-friendly"]
    end

    classDef dev fill:#87CEEB
    classDef prod fill:#90EE90
    class StackTrace,InnerException,RequestDetails dev
    class NoStackTrace,NoInnerException,NoRequestDetails,GenericMessage prod
    </div>

    <footer>
        <p>ln-772-error-handler-setup v2.0.0 | Last Updated: 2026-01-10</p>
    </footer>
</body>
</html>
