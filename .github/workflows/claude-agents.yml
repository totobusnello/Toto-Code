name: Claude Code Agents

on:
  # Trigger via issue/PR comments
  issue_comment:
    types: [created]

  # Trigger manually
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to use (e.g., code-reviewer, security-auditor)'
        required: true
        default: 'code-reviewer'
      prompt:
        description: 'Prompt/task for the agent'
        required: true
        default: 'Review this codebase'

  # Trigger on PR for auto code review
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # Job 1: Handle comment triggers like "/agent security-auditor"
  handle-comment:
    if: github.event_name == 'issue_comment' && startsWith(github.event.comment.body, '/agent')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Parse agent command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          # Extract agent name: /agent <agent-name> [prompt]
          AGENT=$(echo "$COMMENT" | sed -n 's|^/agent \([^ ]*\).*|\1|p')
          PROMPT=$(echo "$COMMENT" | sed 's|^/agent [^ ]* *||')

          if [ -z "$PROMPT" ]; then
            PROMPT="Execute your default task on this codebase"
          fi

          echo "agent=$AGENT" >> $GITHUB_OUTPUT
          echo "prompt=$PROMPT" >> $GITHUB_OUTPUT

      - name: Run Claude Code Agent
        id: claude
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          AGENT="${{ steps.parse.outputs.agent }}"
          PROMPT="${{ steps.parse.outputs.prompt }}"

          # Map common agent names to full prompts
          case "$AGENT" in
            "code-reviewer"|"review")
              FULL_PROMPT="Act as a code-reviewer agent. Review the code changes and provide detailed feedback on: code quality, potential bugs, security issues, and suggestions for improvement. $PROMPT"
              ;;
            "security-auditor"|"security")
              FULL_PROMPT="Act as a security-auditor agent. Perform a security audit of this codebase. Check for: OWASP Top 10 vulnerabilities, hardcoded secrets, insecure dependencies, and security best practices. $PROMPT"
              ;;
            "debugger"|"debug")
              FULL_PROMPT="Act as a debugger agent. Analyze the code for potential bugs, edge cases, and error handling issues. $PROMPT"
              ;;
            "documentation-engineer"|"docs")
              FULL_PROMPT="Act as a documentation-engineer agent. Review and suggest improvements for documentation. $PROMPT"
              ;;
            "refactoring-specialist"|"refactor")
              FULL_PROMPT="Act as a refactoring-specialist agent. Analyze the code and suggest refactoring opportunities for better maintainability. $PROMPT"
              ;;
            "test-automator"|"test")
              FULL_PROMPT="Act as a test-automator agent. Analyze the code and suggest tests that should be written. $PROMPT"
              ;;
            *)
              FULL_PROMPT="Act as a $AGENT agent. $PROMPT"
              ;;
          esac

          # Run Claude Code and capture output
          OUTPUT=$(claude --print "$FULL_PROMPT" 2>&1) || true

          # Save output to file (handle multiline)
          echo "$OUTPUT" > /tmp/claude_output.txt

          # Set output for next step
          echo "output_file=/tmp/claude_output.txt" >> $GITHUB_OUTPUT

      - name: Post result to issue/PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/claude_output.txt', 'utf8');
            const agent = '${{ steps.parse.outputs.agent }}';

            const body = `## ü§ñ Agent: \`${agent}\`\n\n${output}\n\n---\n*Powered by Claude Code*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # Job 2: Auto code review on PRs
  auto-review:
    if: github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'claude-review')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/pr_diff.txt
          echo "diff_file=/tmp/pr_diff.txt" >> $GITHUB_OUTPUT

      - name: Run Claude Code Review
        id: review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          DIFF=$(cat /tmp/pr_diff.txt)

          claude --print "Act as a code-reviewer agent. Review this PR diff and provide:
          1. Summary of changes
          2. Potential issues or bugs
          3. Security concerns
          4. Suggestions for improvement

          PR Diff:
          $DIFF" > /tmp/review_output.txt 2>&1 || true

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/review_output.txt', 'utf8');

            const body = `## üîç Claude Code Review\n\n${output}\n\n---\n*Automated review by Claude Code*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

  # Job 3: Manual workflow dispatch
  manual-agent:
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Run Claude Code Agent
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          AGENT="${{ github.event.inputs.agent }}"
          PROMPT="${{ github.event.inputs.prompt }}"

          echo "## Running Agent: $AGENT"
          echo "## Prompt: $PROMPT"
          echo "---"

          claude --print "Act as a $AGENT agent. $PROMPT"
