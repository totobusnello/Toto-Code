name: Claude Quick Commands

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  quick-command:
    if: |
      github.event.issue.pull_request &&
      (startsWith(github.event.comment.body, '/review') ||
       startsWith(github.event.comment.body, '/security') ||
       startsWith(github.event.comment.body, '/test') ||
       startsWith(github.event.comment.body, '/docs') ||
       startsWith(github.event.comment.body, '/refactor') ||
       startsWith(github.event.comment.body, '/debug') ||
       startsWith(github.event.comment.body, '/explain'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      - name: Run Quick Command
        id: run
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          COMMENT="${{ github.event.comment.body }}"
          COMMAND=$(echo "$COMMENT" | awk '{print $1}')
          EXTRA=$(echo "$COMMENT" | sed 's|^/[^ ]* *||')

          case "$COMMAND" in
            "/review")
              PROMPT="Act as code-reviewer-pro agent from my team. Do a thorough code review of the changes in this PR. Focus on: code quality, bugs, security, performance, and maintainability. $EXTRA"
              EMOJI="magnifying_glass_tilted_left"
              TITLE="Code Review"
              ;;
            "/security")
              PROMPT="Act as security-auditor agent. Perform a security audit: check OWASP Top 10, secrets, SQL injection, XSS, CSRF, auth issues. $EXTRA"
              EMOJI="shield"
              TITLE="Security Audit"
              ;;
            "/test")
              PROMPT="Act as test-automator agent. Analyze this code and suggest comprehensive tests: unit tests, integration tests, edge cases. Provide example test code. $EXTRA"
              EMOJI="test_tube"
              TITLE="Test Suggestions"
              ;;
            "/docs")
              PROMPT="Act as documentation-engineer agent. Review and suggest documentation improvements. Generate docstrings, README updates, and API docs as needed. $EXTRA"
              EMOJI="books"
              TITLE="Documentation"
              ;;
            "/refactor")
              PROMPT="Act as refactoring-specialist agent. Analyze code for refactoring opportunities: reduce complexity, improve readability, apply design patterns. $EXTRA"
              EMOJI="recycle"
              TITLE="Refactoring Suggestions"
              ;;
            "/debug")
              PROMPT="Act as debugger agent. Analyze this code for: potential bugs, edge cases, error handling, race conditions, memory leaks. $EXTRA"
              EMOJI="beetle"
              TITLE="Debug Analysis"
              ;;
            "/explain")
              PROMPT="Explain this codebase/changes in detail. What does it do? How does it work? What are the key components? $EXTRA"
              EMOJI="teacher"
              TITLE="Code Explanation"
              ;;
            *)
              PROMPT="$COMMENT"
              EMOJI="robot"
              TITLE="Claude Response"
              ;;
          esac

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT

          # Get the PR diff for context
          git diff origin/${{ github.base_ref }}...HEAD > /tmp/diff.txt 2>/dev/null || true

          # Run Claude with the diff context
          {
            echo "Context: This is a PR review. Here's the diff:"
            echo '```diff'
            head -500 /tmp/diff.txt
            echo '```'
            echo ""
            echo "$PROMPT"
          } | claude --print - > /tmp/output.txt 2>&1 || true

      - name: Post result
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const output = fs.readFileSync('/tmp/output.txt', 'utf8');
            const title = '${{ steps.run.outputs.title }}';

            // Truncate if too long
            const maxLength = 60000;
            const truncated = output.length > maxLength
              ? output.substring(0, maxLength) + '\n\n... (truncated)'
              : output;

            const body = `## ${title}\n\n${truncated}\n\n---\n*Claude Code Agent*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

            // Add success reaction
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
