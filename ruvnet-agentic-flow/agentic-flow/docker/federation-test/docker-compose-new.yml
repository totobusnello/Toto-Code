services:
  # Federation Hub Server
  federation-hub:
    build:
      context: ../..
      dockerfile: docker/federation-test/Dockerfile.hub.new
    container_name: federation-hub
    ports:
      - "8443:8443"
      - "8444:8444"
    environment:
      - NODE_ENV=production
      - HUB_PORT=8443
      - HUB_DB_PATH=/data/hub.db
      - DEBUG_LEVEL=DETAILED
      - DEBUG_FORMAT=human
    volumes:
      - hub-data:/data
      - ../../docker/federation-test:/app/docker/federation-test
    networks:
      - federation-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8444/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 10s

  # Agent 1: Researcher (finds patterns)
  agent-researcher:
    build:
      context: ../..
      dockerfile: docker/federation-test/Dockerfile.agent.new
    container_name: agent-researcher
    depends_on:
      federation-hub:
        condition: service_healthy
    environment:
      - AGENT_TYPE=researcher
      - AGENT_ID=researcher-001
      - TENANT_ID=test-collaboration
      - HUB_ENDPOINT=ws://federation-hub:8443
      - TASK=research
      - DEBUG_LEVEL=DETAILED
    volumes:
      - ../../docker/federation-test:/app/docker/federation-test
    networks:
      - federation-network

  # Agent 2: Coder (implements solutions)
  agent-coder:
    build:
      context: ../..
      dockerfile: docker/federation-test/Dockerfile.agent.new
    container_name: agent-coder
    depends_on:
      federation-hub:
        condition: service_healthy
    environment:
      - AGENT_TYPE=coder
      - AGENT_ID=coder-001
      - TENANT_ID=test-collaboration
      - HUB_ENDPOINT=ws://federation-hub:8443
      - TASK=implement
      - DEBUG_LEVEL=DETAILED
    volumes:
      - ../../docker/federation-test:/app/docker/federation-test
    networks:
      - federation-network

  # Agent 3: Tester (validates work)
  agent-tester:
    build:
      context: ../..
      dockerfile: docker/federation-test/Dockerfile.agent.new
    container_name: agent-tester
    depends_on:
      federation-hub:
        condition: service_healthy
    environment:
      - AGENT_TYPE=tester
      - AGENT_ID=tester-001
      - TENANT_ID=test-collaboration
      - HUB_ENDPOINT=ws://federation-hub:8443
      - TASK=validate
      - DEBUG_LEVEL=DETAILED
    volumes:
      - ../../docker/federation-test:/app/docker/federation-test
    networks:
      - federation-network

  # Agent 4: Reviewer (quality check)
  agent-reviewer:
    build:
      context: ../..
      dockerfile: docker/federation-test/Dockerfile.agent.new
    container_name: agent-reviewer
    depends_on:
      federation-hub:
        condition: service_healthy
    environment:
      - AGENT_TYPE=reviewer
      - AGENT_ID=reviewer-001
      - TENANT_ID=test-collaboration
      - HUB_ENDPOINT=ws://federation-hub:8443
      - TASK=review
      - DEBUG_LEVEL=DETAILED
    volumes:
      - ../../docker/federation-test:/app/docker/federation-test
    networks:
      - federation-network

  # Agent 5: Different tenant (should be isolated)
  agent-isolated:
    build:
      context: ../..
      dockerfile: docker/federation-test/Dockerfile.agent.new
    container_name: agent-isolated
    depends_on:
      federation-hub:
        condition: service_healthy
    environment:
      - AGENT_TYPE=researcher
      - AGENT_ID=isolated-001
      - TENANT_ID=different-tenant
      - HUB_ENDPOINT=ws://federation-hub:8443
      - TASK=research
      - DEBUG_LEVEL=DETAILED
    volumes:
      - ../../docker/federation-test:/app/docker/federation-test
    networks:
      - federation-network

volumes:
  hub-data:
    driver: local

networks:
  federation-network:
    driver: bridge
