# AgentDB v2 Validation Dockerfile
# Tests backward compatibility, CLI commands, MCP tools, and migration

FROM node:20-slim

# Install build dependencies including Python for node-gyp
RUN apt-get update && apt-get install -y \
    git \
    curl \
    sqlite3 \
    python3 \
    python3-pip \
    build-essential \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /test

# Copy package files
COPY package.json package-lock.json* ./
COPY tsconfig.json ./
COPY src ./src
COPY tests ./tests
COPY scripts ./scripts

# Install dependencies
RUN npm install

# Build the package
RUN npm run build

# Create test directories
RUN mkdir -p /test/validation/{v1-compat,v2-features,cli,mcp,migration}

# Copy validation scripts
COPY docker-validation/*.sh /test/validation/

# Make scripts executable
RUN chmod +x /test/validation/*.sh

# Set environment variables
ENV NODE_ENV=test
ENV AGENTDB_TEST_MODE=validation

# Default command runs all validations
CMD ["/bin/bash", "/test/validation/run-all-validations.sh"]
