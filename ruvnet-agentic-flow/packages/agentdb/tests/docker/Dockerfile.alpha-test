FROM node:20-slim

# Install dependencies for testing and native module compilation
RUN apt-get update && apt-get install -y \
    git \
    curl \
    sqlite3 \
    python3 \
    make \
    g++ \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Create test directory
WORKDIR /test-agentdb

# Set npm to use production registry
ENV NPM_CONFIG_REGISTRY=https://registry.npmjs.org/

# Install agentdb@alpha globally for npx testing (as root)
RUN npm install -g agentdb@alpha

# Create test user (non-root for security testing)
RUN useradd -m -s /bin/bash tester && \
    chown -R tester:tester /test-agentdb

# Create test project directory
RUN mkdir -p /test-agentdb/project && \
    chown -R tester:tester /test-agentdb/project

# Switch to test user for running tests
USER tester

WORKDIR /test-agentdb/project

# Initialize npm project for local package testing
RUN npm init -y

# Default command runs validation script
CMD ["bash"]
