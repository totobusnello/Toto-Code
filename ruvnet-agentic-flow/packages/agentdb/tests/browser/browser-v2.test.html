<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgentDB v2 Browser Test Suite</title>
  <script src="../dist/agentdb.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #2c3e50; }
    h2 { color: #34495e; margin-top: 30px; }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-result {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 14px;
    }
    .test-pass { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
    .test-fail { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
    .test-info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
    .test-warn { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
    pre {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value { font-size: 32px; font-weight: bold; }
    .stat-label { font-size: 14px; opacity: 0.9; }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px;
    }
    button:hover { background: #5568d3; }
    button:active { background: #4451b8; }
  </style>
</head>
<body>
  <h1>üß™ AgentDB v2.0.0 Browser Test Suite</h1>
  <p>Comprehensive testing of AgentDB v2 browser bundle with v1 API backward compatibility</p>

  <div class="stats" id="stats">
    <div class="stat-card">
      <div class="stat-value" id="totalTests">0</div>
      <div class="stat-label">Total Tests</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
      <div class="stat-value" id="passedTests">0</div>
      <div class="stat-label">Passed</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);">
      <div class="stat-value" id="failedTests">0</div>
      <div class="stat-label">Failed</div>
    </div>
    <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
      <div class="stat-value" id="duration">0ms</div>
      <div class="stat-label">Duration</div>
    </div>
  </div>

  <div style="margin: 20px 0;">
    <button onclick="runAllTests()">‚ñ∂Ô∏è Run All Tests</button>
    <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    <button onclick="exportResults()">üíæ Export Results</button>
  </div>

  <div id="results"></div>

  <script>
    let totalTests = 0;
    let passedTests = 0;
    let failedTests = 0;
    let startTime = 0;

    function log(message, type = 'info') {
      const result = document.createElement('div');
      result.className = `test-result test-${type}`;
      result.innerHTML = message;
      document.getElementById('results').appendChild(result);
    }

    function assert(condition, message) {
      totalTests++;
      if (condition) {
        passedTests++;
        log(`‚úÖ PASS: ${message}`, 'pass');
        return true;
      } else {
        failedTests++;
        log(`‚ùå FAIL: ${message}`, 'fail');
        return false;
      }
    }

    function updateStats() {
      document.getElementById('totalTests').textContent = totalTests;
      document.getElementById('passedTests').textContent = passedTests;
      document.getElementById('failedTests').textContent = failedTests;
      document.getElementById('duration').textContent = `${Date.now() - startTime}ms`;
    }

    function clearResults() {
      document.getElementById('results').innerHTML = '';
      totalTests = 0;
      passedTests = 0;
      failedTests = 0;
      updateStats();
    }

    function exportResults() {
      const results = {
        totalTests,
        passedTests,
        failedTests,
        duration: Date.now() - startTime,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent
      };
      const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `agentdb-v2-test-results-${Date.now()}.json`;
      a.click();
    }

    async function runAllTests() {
      clearResults();
      startTime = Date.now();

      log('<h2>üöÄ Starting AgentDB v2 Browser Test Suite</h2>', 'info');

      // Test 1: AgentDB namespace availability
      log('<div class="test-section"><h2>Test Suite 1: Namespace & Initialization</h2></div>', 'info');
      assert(typeof AgentDB !== 'undefined', 'AgentDB namespace is available');
      assert(typeof AgentDB.Database !== 'undefined', 'AgentDB.Database class is available');
      assert(typeof AgentDB.SQLiteVectorDB !== 'undefined', 'AgentDB.SQLiteVectorDB alias is available');
      assert(AgentDB.version.startsWith('2.'), `AgentDB version is v2 (got: ${AgentDB.version})`);
      updateStats();

      // Test 2: Database initialization
      log('<div class="test-section"><h2>Test Suite 2: Database Initialization</h2></div>', 'info');

      await new Promise(resolve => {
        AgentDB.onReady(async () => {
          log('‚úÖ AgentDB ready callback triggered', 'pass');

          const db = new AgentDB.SQLiteVectorDB({
            memoryMode: true,
            backend: 'wasm',
            enableGNN: true
          });

          assert(db !== null, 'Database instance created');

          await db.initializeAsync();
          log('‚úÖ Database initialized asynchronously', 'pass');
          updateStats();

          // Test 3: v1 API backward compatibility
          log('<div class="test-section"><h2>Test Suite 3: v1 API Backward Compatibility</h2></div>', 'info');

          // Test v1 pattern storage
          const pattern1 = db.storePattern({
            pattern: JSON.stringify({ campaign: 'E-commerce', strategy: 'Budget optimization', roas: 3.2 }),
            metadata: { test: true }
          });
          assert(pattern1.lastID > 0, `v1 storePattern works (ID: ${pattern1.lastID})`);

          // Test v1 episode storage
          const episode1 = db.storeEpisode({
            trajectory: JSON.stringify({ action: 'Increase budget', result: 'ROAS improved' }),
            reflection: 'Good performance',
            verdict: 'success',
            metadata: { test: true }
          });
          assert(episode1.lastID > 0, `v1 storeEpisode works (ID: ${episode1.lastID})`);

          // Test v1 causal edge
          const edge1 = db.addCausalEdge({
            cause: 'Budget increase',
            effect: 'ROAS improvement',
            strength: 0.85,
            metadata: { test: true }
          });
          assert(edge1.lastID > 0, `v1 addCausalEdge works (ID: ${edge1.lastID})`);

          // Test v1 search
          const searchResults = db.search('budget', { limit: 5 });
          assert(Array.isArray(searchResults), 'v1 search returns array');
          log(`‚ÑπÔ∏è v1 search found ${searchResults.length} results`, 'info');

          updateStats();

          // Test 4: v2 Enhanced API
          log('<div class="test-section"><h2>Test Suite 4: v2 Enhanced API</h2></div>', 'info');

          // Test v2 episodes.store
          const episode2 = await db.episodes.store({
            task: 'Optimize Meta Ads campaign',
            input: JSON.stringify({ budget: 1000, target_roas: 2.5 }),
            output: JSON.stringify({ new_budget: 1200, predicted_roas: 3.2 }),
            reward: 0.85,
            success: true,
            session_id: 'test-session-1',
            critique: 'Excellent performance! Budget increase justified.'
          });
          assert(episode2.id > 0, `v2 episodes.store works (ID: ${episode2.id})`);

          // Test v2 skills.store
          const skill1 = await db.skills.store({
            name: 'Budget Allocation',
            description: 'ML-based budget allocation using historical ROAS',
            signature: JSON.stringify({ inputs: { budget: 'number' }, outputs: { allocation: 'object' } }),
            code: 'function allocateBudget(budget) { return budget * 0.8; }',
            success_rate: 0.92,
            uses: 47
          });
          assert(skill1.id > 0, `v2 skills.store works (ID: ${skill1.id})`);

          // Test v2 causal_edges.add
          const edge2 = await db.causal_edges.add({
            from_memory_id: 1,
            from_memory_type: 'episode',
            to_memory_id: 2,
            to_memory_type: 'episode',
            similarity: 0.87,
            uplift: 0.15,
            confidence: 0.92,
            sample_size: 10
          });
          assert(edge2.id > 0, `v2 causal_edges.add works (ID: ${edge2.id})`);

          updateStats();

          // Test 5: Semantic search
          log('<div class="test-section"><h2>Test Suite 5: Semantic Search with Embeddings</h2></div>', 'info');

          // Add more episodes for search testing
          await db.episodes.store({
            task: 'Budget reallocation strategy',
            input: JSON.stringify({ campaigns: 3 }),
            output: JSON.stringify({ success: true }),
            reward: 0.78,
            success: true,
            session_id: 'test-session-2',
            critique: 'Good ROAS improvement'
          });

          await db.episodes.store({
            task: 'Creative testing for ads',
            input: JSON.stringify({ variants: 5 }),
            output: JSON.stringify({ winner: 'variant-3' }),
            reward: 0.65,
            success: true,
            session_id: 'test-session-3',
            critique: 'Found winning creative'
          });

          // Search for similar episodes
          const searchResults2 = await db.episodes.search({
            task: 'budget optimization',
            k: 3,
            minReward: 0.7,
            onlySuccesses: true
          });

          assert(Array.isArray(searchResults2), 'v2 episodes.search returns array');
          assert(searchResults2.length > 0, `Found ${searchResults2.length} similar episodes`);

          if (searchResults2.length > 0) {
            const firstResult = searchResults2[0];
            assert(typeof firstResult.similarity === 'number', 'Search result has similarity score');
            assert(firstResult.similarity >= 0 && firstResult.similarity <= 1, 'Similarity score in valid range [0,1]');
            log(`‚ÑπÔ∏è Top result: "${firstResult.task}" (similarity: ${firstResult.similarity.toFixed(2)})`, 'info');
          }

          updateStats();

          // Test 6: Statistics and analytics
          log('<div class="test-section"><h2>Test Suite 6: Statistics & Analytics</h2></div>', 'info');

          const stats = await db.episodes.getStats({
            task: 'budget optimization',
            k: 10
          });

          assert(typeof stats.avgReward === 'number', 'Stats include average reward');
          assert(typeof stats.successRate === 'number', 'Stats include success rate');
          assert(typeof stats.totalEpisodes === 'number', 'Stats include total episodes');
          assert(Array.isArray(stats.critiques), 'Stats include critiques array');

          log(`<pre>Episode Statistics:
  Avg Reward: ${stats.avgReward.toFixed(2)}
  Success Rate: ${(stats.successRate * 100).toFixed(1)}%
  Total Episodes: ${stats.totalEpisodes}
  Critiques: ${stats.critiques.length} entries</pre>`, 'info');

          updateStats();

          // Test 7: Export and data verification
          log('<div class="test-section"><h2>Test Suite 7: Export & Data Verification</h2></div>', 'info');

          const exportedData = db.export();
          assert(exportedData instanceof Uint8Array, 'Database exports to Uint8Array');
          assert(exportedData.length > 0, `Export data size: ${exportedData.length} bytes`);

          // Query actual data
          const episodesCount = db.exec('SELECT COUNT(*) as count FROM episodes');
          const skillsCount = db.exec('SELECT COUNT(*) as count FROM skills');
          const edgesCount = db.exec('SELECT COUNT(*) as count FROM causal_edges');

          log(`<pre>Database Contents:
  Episodes (v2): ${episodesCount[0]?.values[0]?.[0] || 0}
  Skills (v2): ${skillsCount[0]?.values[0]?.[0] || 0}
  Causal Edges (v2): ${edgesCount[0]?.values[0]?.[0] || 0}</pre>`, 'info');

          updateStats();

          // Test 8: Performance benchmarks
          log('<div class="test-section"><h2>Test Suite 8: Performance Benchmarks</h2></div>', 'info');

          // Benchmark insert
          const insertStart = performance.now();
          for (let i = 0; i < 100; i++) {
            await db.episodes.store({
              task: `Benchmark task ${i}`,
              input: JSON.stringify({ iter: i }),
              output: JSON.stringify({ result: i }),
              reward: Math.random(),
              success: Math.random() > 0.3,
              session_id: 'benchmark',
              critique: 'Benchmark episode'
            });
          }
          const insertTime = performance.now() - insertStart;
          log(`‚ö° Insert performance: 100 episodes in ${insertTime.toFixed(2)}ms (${(insertTime / 100).toFixed(2)}ms per insert)`, 'info');

          // Benchmark search
          const searchStart = performance.now();
          for (let i = 0; i < 20; i++) {
            await db.episodes.search({ task: 'benchmark', k: 10 });
          }
          const searchTime = performance.now() - searchStart;
          log(`‚ö° Search performance: 20 searches in ${searchTime.toFixed(2)}ms (${(searchTime / 20).toFixed(2)}ms per search)`, 'info');

          updateStats();

          // Final summary
          log('<div class="test-section"><h2>üìä Test Summary</h2></div>', 'info');
          const passRate = ((passedTests / totalTests) * 100).toFixed(1);

          if (failedTests === 0) {
            log(`<h3 style="color: #28a745;">üéâ All Tests Passed! (${passRate}%)</h3>`, 'pass');
          } else {
            log(`<h3 style="color: #ffc107;">‚ö†Ô∏è ${failedTests} Test(s) Failed (${passRate}% pass rate)</h3>`, 'warn');
          }

          log(`<pre>Total Tests: ${totalTests}
Passed: ${passedTests}
Failed: ${failedTests}
Duration: ${Date.now() - startTime}ms

Browser: ${navigator.userAgent}
AgentDB Version: ${AgentDB.version}</pre>`, 'info');

          // Close database
          db.close();
          log('‚úÖ Database closed successfully', 'pass');

          resolve();
        });
      });
    }

    // Auto-run on load
    window.addEventListener('load', () => {
      log('<p style="color: #666;">Click "Run All Tests" to start the test suite</p>', 'info');
    });
  </script>
</body>
</html>
