<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>AgentDB Advanced Features - Verification Test</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      color: #333;
      border-bottom: 3px solid #4CAF50;
      padding-bottom: 10px;
    }
    .test-section {
      background: white;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .test-section h2 {
      color: #2196F3;
      margin-top: 0;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: bold;
      margin-left: 10px;
    }
    .status.pass {
      background: #4CAF50;
      color: white;
    }
    .status.fail {
      background: #f44336;
      color: white;
    }
    .status.pending {
      background: #FF9800;
      color: white;
    }
    .code {
      background: #f0f0f0;
      padding: 10px;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .metric {
      display: inline-block;
      margin: 10px 20px 10px 0;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 4px;
    }
    .metric strong {
      color: #1976D2;
    }
    #results {
      margin-top: 20px;
    }
    .test-item {
      padding: 8px;
      margin: 5px 0;
      border-left: 4px solid #ccc;
      background: #fafafa;
    }
    .test-item.pass {
      border-left-color: #4CAF50;
    }
    .test-item.fail {
      border-left-color: #f44336;
    }
    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    button:hover {
      background: #1976D2;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>üöÄ AgentDB Advanced Features - Verification Test</h1>

  <div class="test-section">
    <h2>Bundle Information</h2>
    <div class="metric">
      <strong>Version:</strong> <span id="version">Loading...</span>
    </div>
    <div class="metric">
      <strong>Bundle Size:</strong> 66.88 KB (minified), 22.29 KB (gzipped)
    </div>
    <div class="metric">
      <strong>Features:</strong> <span id="feature-count">10</span>
    </div>
  </div>

  <div class="test-section">
    <h2>üîç Feature Detection</h2>
    <div id="feature-detection">
      <p>Running feature detection tests...</p>
    </div>
  </div>

  <div class="test-section">
    <h2>‚ö° Quick Functionality Tests</h2>
    <button onclick="runAllTests()" id="run-tests">Run All Tests</button>
    <button onclick="runPerformanceBenchmark()" id="run-benchmark">Run Performance Benchmark</button>
    <div id="results"></div>
  </div>

  <div class="test-section">
    <h2>üìä Performance Metrics</h2>
    <div id="performance-metrics">
      <p>Run benchmark to see performance metrics...</p>
    </div>
  </div>

  <!-- Load AgentDB Advanced Bundle -->
  <script src="../dist/agentdb-advanced.min.js"></script>

  <script>
    const results = [];

    function log(message, status = 'info') {
      const resultDiv = document.getElementById('results');
      const item = document.createElement('div');
      item.className = `test-item ${status}`;
      item.textContent = message;
      resultDiv.appendChild(item);

      if (status === 'pass') {
        results.push({ message, pass: true });
      } else if (status === 'fail') {
        results.push({ message, pass: false });
      }
    }

    async function testFeatureDetection() {
      log('Testing feature detection...', 'info');

      try {
        const features = AgentDB.Advanced.detectFeatures();

        document.getElementById('feature-detection').innerHTML = `
          <div class="code">${JSON.stringify(features, null, 2)}</div>
        `;

        log(`‚úì Feature detection working`, 'pass');
        log(`  - IndexedDB: ${features.indexedDB ? 'Available' : 'Not available'}`, 'info');
        log(`  - BroadcastChannel: ${features.broadcastChannel ? 'Available' : 'Not available'}`, 'info');
        log(`  - Web Workers: ${features.webWorkers ? 'Available' : 'Not available'}`, 'info');

        return true;
      } catch (error) {
        log(`‚úó Feature detection failed: ${error.message}`, 'fail');
        return false;
      }
    }

    async function testProductQuantization() {
      log('Testing Product Quantization (PQ8)...', 'info');

      try {
        const pq = AgentDB.Advanced.createPQ8(384);

        // Create test vectors
        const vectors = [];
        for (let i = 0; i < 10; i++) {
          const vec = new Float32Array(384);
          for (let j = 0; j < 384; j++) {
            vec[j] = Math.random() - 0.5;
          }
          vectors.push(vec);
        }

        // Train
        await pq.train(vectors);

        // Compress
        const compressed = pq.compress(vectors[0]);
        const stats = pq.getStats();

        log(`‚úì Product Quantization working`, 'pass');
        log(`  - Compression ratio: ${stats.compressionRatio.toFixed(1)}x`, 'info');
        log(`  - Memory per vector: ${stats.memoryPerVector} bytes`, 'info');
        log(`  - Codebook size: ${(stats.codebookSize / 1024).toFixed(2)} KB`, 'info');

        return true;
      } catch (error) {
        log(`‚úó Product Quantization failed: ${error.message}`, 'fail');
        return false;
      }
    }

    async function testHNSW() {
      log('Testing HNSW Index...', 'info');

      try {
        const hnsw = AgentDB.Advanced.createHNSW(384);

        // Add vectors
        for (let i = 0; i < 100; i++) {
          const vec = new Float32Array(384);
          for (let j = 0; j < 384; j++) {
            vec[j] = Math.random() - 0.5;
          }
          hnsw.add(vec, i);
        }

        // Search
        const query = new Float32Array(384);
        for (let i = 0; i < 384; i++) {
          query[i] = Math.random() - 0.5;
        }

        const results = hnsw.search(query, 10);
        const stats = hnsw.getStats();

        log(`‚úì HNSW Index working`, 'pass');
        log(`  - Nodes: ${stats.numNodes}`, 'info');
        log(`  - Layers: ${stats.numLayers}`, 'info');
        log(`  - Avg connections: ${stats.avgConnections.toFixed(2)}`, 'info');
        log(`  - Search returned ${results.length} results`, 'info');

        return true;
      } catch (error) {
        log(`‚úó HNSW Index failed: ${error.message}`, 'fail');
        return false;
      }
    }

    async function testGNN() {
      log('Testing Graph Neural Networks...', 'info');

      try {
        const gnn = new AgentDB.Advanced.GraphNeuralNetwork({ numHeads: 4 });

        // Add nodes
        const feat1 = new Float32Array(64);
        const feat2 = new Float32Array(64);
        const feat3 = new Float32Array(64);
        for (let i = 0; i < 64; i++) {
          feat1[i] = Math.random();
          feat2[i] = Math.random();
          feat3[i] = Math.random();
        }

        gnn.addNode(1, feat1);
        gnn.addNode(2, feat2);
        gnn.addNode(3, feat3);

        // Add edges
        gnn.addEdge(1, 2, 0.9);
        gnn.addEdge(2, 3, 0.8);

        // Compute graph embedding
        const embedding = gnn.computeGraphEmbedding(2, 2);
        const stats = gnn.getStats();

        log(`‚úì Graph Neural Networks working`, 'pass');
        log(`  - Nodes: ${stats.numNodes}`, 'info');
        log(`  - Edges: ${stats.numEdges}`, 'info');
        log(`  - Avg degree: ${stats.avgDegree.toFixed(2)}`, 'info');

        return true;
      } catch (error) {
        log(`‚úó Graph Neural Networks failed: ${error.message}`, 'fail');
        return false;
      }
    }

    async function testMMR() {
      log('Testing Maximal Marginal Relevance...', 'info');

      try {
        const mmr = new AgentDB.Advanced.MaximalMarginalRelevance({ lambda: 0.7 });

        const query = new Float32Array(64);
        for (let i = 0; i < 64; i++) {
          query[i] = Math.random();
        }

        const candidates = [];
        for (let i = 0; i < 20; i++) {
          const vec = new Float32Array(64);
          for (let j = 0; j < 64; j++) {
            vec[j] = Math.random();
          }
          candidates.push({ id: i, vector: vec, score: Math.random() });
        }

        const reranked = mmr.rerank(query, candidates, 10);

        log(`‚úì MMR Diversity Ranking working`, 'pass');
        log(`  - Input candidates: ${candidates.length}`, 'info');
        log(`  - Diverse results: ${reranked.length}`, 'info');

        return true;
      } catch (error) {
        log(`‚úó MMR Diversity Ranking failed: ${error.message}`, 'fail');
        return false;
      }
    }

    async function testBatchOperations() {
      log('Testing Batch Operations...', 'info');

      try {
        const query = new Float32Array(384);
        const vectors = [];
        for (let i = 0; i < 100; i++) {
          const vec = new Float32Array(384);
          for (let j = 0; j < 384; j++) {
            query[j] = Math.random();
            vec[j] = Math.random();
          }
          vectors.push(vec);
        }

        const startBatch = performance.now();
        const similarities = AgentDB.Advanced.BatchProcessor.batchCosineSimilarity(query, vectors);
        const batchTime = performance.now() - startBatch;

        const normalized = AgentDB.Advanced.BatchProcessor.batchNormalize(vectors);

        log(`‚úì Batch Operations working`, 'pass');
        log(`  - Batch similarity computed for ${vectors.length} vectors`, 'info');
        log(`  - Time: ${batchTime.toFixed(2)}ms`, 'info');
        log(`  - Normalized ${normalized.length} vectors`, 'info');

        return true;
      } catch (error) {
        log(`‚úó Batch Operations failed: ${error.message}`, 'fail');
        return false;
      }
    }

    async function testAgentDB() {
      log('Testing AgentDB with advanced features...', 'info');

      try {
        const db = new AgentDB.SQLiteVectorDB({
          enablePQ: true,
          enableHNSW: true,
          enableGNN: true,
          enableMMR: true
        });

        await db.initializeAsync();

        // Store episodes
        for (let i = 0; i < 10; i++) {
          await db.episodes.store({
            task: `Test task ${i}`,
            reward: Math.random(),
            success: Math.random() > 0.5
          });
        }

        // Search
        const results = await db.episodes.search({
          task: 'test',
          k: 5,
          diversify: true
        });

        const advStats = db.advanced.stats();

        log(`‚úì AgentDB integration working`, 'pass');
        log(`  - Stored 10 episodes`, 'info');
        log(`  - Search returned ${results.length} results`, 'info');
        log(`  - PQ enabled: ${advStats.pq !== null}`, 'info');
        log(`  - HNSW enabled: ${advStats.hnsw !== null}`, 'info');
        log(`  - GNN enabled: ${advStats.gnn !== null}`, 'info');

        return true;
      } catch (error) {
        log(`‚úó AgentDB integration failed: ${error.message}`, 'fail');
        return false;
      }
    }

    async function runAllTests() {
      const button = document.getElementById('run-tests');
      button.disabled = true;
      button.textContent = 'Running tests...';

      document.getElementById('results').innerHTML = '';
      results.length = 0;

      await testFeatureDetection();
      await testProductQuantization();
      await testHNSW();
      await testGNN();
      await testMMR();
      await testBatchOperations();
      await testAgentDB();

      const passed = results.filter(r => r.pass).length;
      const total = results.length;

      log('', 'info');
      log(`========================================`, 'info');
      log(`TESTS COMPLETE: ${passed}/${total} passed`, passed === total ? 'pass' : 'fail');
      log(`========================================`, 'info');

      button.disabled = false;
      button.textContent = 'Run All Tests';
    }

    async function runPerformanceBenchmark() {
      const button = document.getElementById('run-benchmark');
      button.disabled = true;
      button.textContent = 'Running benchmark...';

      const metricsDiv = document.getElementById('performance-metrics');
      metricsDiv.innerHTML = '<p>Running performance benchmark...</p>';

      try {
        // Create test data
        const db = new AgentDB.SQLiteVectorDB({
          enableHNSW: true
        });

        await db.initializeAsync();

        // Add 1000 vectors
        const addStart = performance.now();
        for (let i = 0; i < 1000; i++) {
          await db.episodes.store({
            task: `Benchmark task ${i}`,
            reward: Math.random(),
            success: true
          });
        }
        const addTime = performance.now() - addStart;

        // Benchmark search
        const searchFn = async (query, k) => {
          return await db.episodes.search({ task: 'benchmark', k });
        };

        const benchResults = await AgentDB.Advanced.benchmarkSearch(searchFn, 100, 10, 384);

        metricsDiv.innerHTML = `
          <h3>Insertion Performance</h3>
          <div class="metric"><strong>1000 vectors inserted in:</strong> ${addTime.toFixed(2)}ms</div>
          <div class="metric"><strong>Avg per insert:</strong> ${(addTime / 1000).toFixed(2)}ms</div>

          <h3>Search Performance (100 queries)</h3>
          <div class="metric"><strong>Average:</strong> ${benchResults.avgTimeMs.toFixed(2)}ms</div>
          <div class="metric"><strong>Minimum:</strong> ${benchResults.minTimeMs.toFixed(2)}ms</div>
          <div class="metric"><strong>Maximum:</strong> ${benchResults.maxTimeMs.toFixed(2)}ms</div>
          <div class="metric"><strong>P50 (median):</strong> ${benchResults.p50Ms.toFixed(2)}ms</div>
          <div class="metric"><strong>P95:</strong> ${benchResults.p95Ms.toFixed(2)}ms</div>
          <div class="metric"><strong>P99:</strong> ${benchResults.p99Ms.toFixed(2)}ms</div>

          <h3>Comparison</h3>
          <div class="code">With HNSW: ${benchResults.avgTimeMs.toFixed(2)}ms per search
Without HNSW (estimated): ${(benchResults.avgTimeMs * 15).toFixed(2)}ms per search
Speedup: ~15x faster with HNSW!</div>
        `;

      } catch (error) {
        metricsDiv.innerHTML = `<p style="color: red;">Benchmark failed: ${error.message}</p>`;
      }

      button.disabled = false;
      button.textContent = 'Run Performance Benchmark';
    }

    // Initialize on page load
    window.addEventListener('load', async () => {
      // Show version
      if (AgentDB && AgentDB.Advanced && AgentDB.Advanced.VERSION) {
        document.getElementById('version').textContent = AgentDB.Advanced.VERSION.full;
      }

      // Auto-run feature detection
      await testFeatureDetection();
    });
  </script>
</body>
</html>
