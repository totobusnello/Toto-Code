# AgentDB v2.0.0-alpha.1 - Docker Compose Configuration
# Orchestrates multi-stage testing and validation

version: '3.8'

services:
  # =============================================================================
  # Build and Test Service
  # =============================================================================
  agentdb-test:
    build:
      context: .
      dockerfile: Dockerfile
      target: test
    container_name: agentdb-test
    volumes:
      - ./tests:/app/tests:ro
      - test-results:/tmp/results
    environment:
      - NODE_ENV=test
      - CI=true
    command: npm run test:unit

  # =============================================================================
  # Package Validation Service
  # =============================================================================
  agentdb-package:
    build:
      context: .
      dockerfile: Dockerfile
      target: package-test
    container_name: agentdb-package
    volumes:
      - package-artifacts:/app
    environment:
      - NODE_ENV=production

  # =============================================================================
  # CLI Validation Service
  # =============================================================================
  agentdb-cli:
    build:
      context: .
      dockerfile: Dockerfile
      target: cli-test
    container_name: agentdb-cli
    volumes:
      - cli-data:/tmp
    environment:
      - NODE_ENV=production
    command: node dist/cli/agentdb-cli.js --help

  # =============================================================================
  # MCP Server Validation Service
  # =============================================================================
  agentdb-mcp:
    build:
      context: .
      dockerfile: Dockerfile
      target: mcp-test
    container_name: agentdb-mcp
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production

  # =============================================================================
  # Production Runtime Service
  # =============================================================================
  agentdb-production:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: agentdb-production
    volumes:
      - agentdb-data:/app/data
    environment:
      - NODE_ENV=production
      - AGENTDB_DATA_DIR=/app/data
    ports:
      - "3000:3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "process.exit(0)"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # =============================================================================
  # Full Test Report Service
  # =============================================================================
  agentdb-report:
    build:
      context: .
      dockerfile: Dockerfile
      target: test-report
    container_name: agentdb-report
    volumes:
      - test-results:/tmp/results
    environment:
      - NODE_ENV=test

# =============================================================================
# Named Volumes
# =============================================================================
volumes:
  agentdb-data:
    driver: local
  test-results:
    driver: local
  package-artifacts:
    driver: local
  cli-data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  default:
    name: agentdb-network
    driver: bridge
