name: Test AgentDB Attention Mechanisms

on:
  push:
    branches: [ main, mcp-dev ]
    paths:
      - 'packages/agentdb/**'
      - '.github/workflows/test-agentdb-attention.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'packages/agentdb/**'

jobs:
  test-attention-integration:
    name: Attention Integration Tests
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        node-version: [18.x, 20.x, 22.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: packages/agentdb/package-lock.json

      - name: Install dependencies
        working-directory: packages/agentdb
        run: npm ci

      - name: Build TypeScript
        working-directory: packages/agentdb
        run: npm run build:ts

      - name: Run attention integration tests
        working-directory: packages/agentdb
        run: npx vitest tests/integration/attention-integration.test.ts --run
        env:
          NODE_OPTIONS: --expose-gc

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: attention-integration-${{ matrix.os }}-node-${{ matrix.node-version }}
          path: packages/agentdb/test-results/
          retention-days: 30

  test-attention-regression:
    name: Attention Regression Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x, 22.x]
        attention-enabled: [true, false]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: packages/agentdb/package-lock.json

      - name: Install dependencies
        working-directory: packages/agentdb
        run: npm ci

      - name: Build TypeScript
        working-directory: packages/agentdb
        run: npm run build:ts

      - name: Run regression tests
        working-directory: packages/agentdb
        run: npx vitest tests/regression/attention-regression.test.ts --run
        env:
          AGENTDB_ATTENTION_ENABLED: ${{ matrix.attention-enabled }}
          NODE_OPTIONS: --expose-gc

      - name: Verify backward compatibility
        working-directory: packages/agentdb
        run: |
          echo "Testing backward compatibility with attention=${{ matrix.attention-enabled }}"
          npx vitest tests/regression/attention-regression.test.ts --run --reporter=json > regression-results.json || true

          FAILED=$(jq '.testResults[].assertionResults[] | select(.status == "failed") | .fullName' regression-results.json | wc -l)

          if [ $FAILED -gt 0 ]; then
            echo "‚ùå Found $FAILED regression failures"
            exit 1
          fi

          echo "‚úÖ No regressions detected"

  test-attention-performance:
    name: Attention Performance Benchmarks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: packages/agentdb/package-lock.json

      - name: Install dependencies
        working-directory: packages/agentdb
        run: npm ci

      - name: Build TypeScript
        working-directory: packages/agentdb
        run: npm run build:ts

      - name: Run performance benchmarks
        working-directory: packages/agentdb
        run: |
          mkdir -p benchmarks/attention
          tsx benchmarks/attention/attention-benchmarks.ts
        env:
          NODE_OPTIONS: --expose-gc --max-old-space-size=4096

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: attention-benchmarks
          path: packages/agentdb/benchmarks/attention/benchmark-results.json
          retention-days: 90

      - name: Compare with baseline
        run: |
          if [ -f "packages/agentdb/benchmarks/attention/benchmark-baseline.json" ]; then
            echo "Comparing with baseline performance..."

            BASELINE_THROUGHPUT=$(jq '.results[0].throughput' packages/agentdb/benchmarks/attention/benchmark-baseline.json)
            CURRENT_THROUGHPUT=$(jq '.results[0].throughput' packages/agentdb/benchmarks/attention/benchmark-results.json)

            THROUGHPUT_RATIO=$(echo "scale=2; $CURRENT_THROUGHPUT / $BASELINE_THROUGHPUT" | bc)

            echo "Throughput ratio: $THROUGHPUT_RATIO"

            if (( $(echo "$THROUGHPUT_RATIO < 0.8" | bc -l) )); then
              echo "‚ö†Ô∏è  Performance degraded by more than 20%"
              exit 1
            fi

            echo "‚úÖ Performance within acceptable range"
          else
            echo "‚ÑπÔ∏è  No baseline available, saving current as baseline"
            cp packages/agentdb/benchmarks/attention/benchmark-results.json \
               packages/agentdb/benchmarks/attention/benchmark-baseline.json
          fi

  test-browser-attention:
    name: Browser Attention Tests
    runs-on: ubuntu-latest

    strategy:
      matrix:
        browser: [chromium, firefox, webkit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: packages/agentdb/package-lock.json

      - name: Install dependencies
        working-directory: packages/agentdb
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Build browser bundle
        working-directory: packages/agentdb
        run: npm run build:browser

      - name: Run browser tests
        working-directory: packages/agentdb
        run: npx playwright test tests/browser/attention-browser.test.js --browser=${{ matrix.browser }}

      - name: Upload browser test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: browser-attention-${{ matrix.browser }}
          path: packages/agentdb/playwright-report/
          retention-days: 30

  test-coverage-attention:
    name: Attention Test Coverage
    runs-on: ubuntu-latest
    needs: [test-attention-integration, test-attention-regression]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
          cache-dependency-path: packages/agentdb/package-lock.json

      - name: Install dependencies
        working-directory: packages/agentdb
        run: npm ci

      - name: Build TypeScript
        working-directory: packages/agentdb
        run: npm run build:ts

      - name: Run tests with coverage
        working-directory: packages/agentdb
        run: npx vitest tests/integration/attention-integration.test.ts tests/regression/attention-regression.test.ts --coverage --run

      - name: Check coverage thresholds
        working-directory: packages/agentdb
        run: |
          # Extract coverage metrics
          STATEMENTS=$(jq '.total.statements.pct' coverage/coverage-summary.json)
          BRANCHES=$(jq '.total.branches.pct' coverage/coverage-summary.json)
          FUNCTIONS=$(jq '.total.functions.pct' coverage/coverage-summary.json)
          LINES=$(jq '.total.lines.pct' coverage/coverage-summary.json)

          echo "Coverage:"
          echo "  Statements: $STATEMENTS%"
          echo "  Branches: $BRANCHES%"
          echo "  Functions: $FUNCTIONS%"
          echo "  Lines: $LINES%"

          # Check thresholds
          if (( $(echo "$STATEMENTS < 85" | bc -l) )); then
            echo "‚ùå Statement coverage ($STATEMENTS%) below threshold (85%)"
            exit 1
          fi

          if (( $(echo "$BRANCHES < 75" | bc -l) )); then
            echo "‚ùå Branch coverage ($BRANCHES%) below threshold (75%)"
            exit 1
          fi

          if (( $(echo "$FUNCTIONS < 85" | bc -l) )); then
            echo "‚ùå Function coverage ($FUNCTIONS%) below threshold (85%)"
            exit 1
          fi

          if (( $(echo "$LINES < 85" | bc -l) )); then
            echo "‚ùå Line coverage ($LINES%) below threshold (85%)"
            exit 1
          fi

          echo "‚úÖ All coverage thresholds met"

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: attention-coverage
          path: packages/agentdb/coverage/
          retention-days: 30

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('packages/agentdb/coverage/coverage-summary.json', 'utf8'));

            const comment = `## üß™ Attention Mechanism Test Coverage

            | Metric | Coverage |
            |--------|----------|
            | Statements | ${coverage.total.statements.pct}% |
            | Branches | ${coverage.total.branches.pct}% |
            | Functions | ${coverage.total.functions.pct}% |
            | Lines | ${coverage.total.lines.pct}% |

            ${coverage.total.statements.pct >= 85 ? '‚úÖ' : '‚ö†Ô∏è'} **Statements**: ${coverage.total.statements.covered}/${coverage.total.statements.total}
            ${coverage.total.branches.pct >= 75 ? '‚úÖ' : '‚ö†Ô∏è'} **Branches**: ${coverage.total.branches.covered}/${coverage.total.branches.total}
            ${coverage.total.functions.pct >= 85 ? '‚úÖ' : '‚ö†Ô∏è'} **Functions**: ${coverage.total.functions.covered}/${coverage.total.functions.total}
            ${coverage.total.lines.pct >= 85 ? '‚úÖ' : '‚ö†Ô∏è'} **Lines**: ${coverage.total.lines.covered}/${coverage.total.lines.total}
            `;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  test-attention-all:
    name: All Attention Tests Passed
    runs-on: ubuntu-latest
    needs:
      - test-attention-integration
      - test-attention-regression
      - test-attention-performance
      - test-browser-attention
      - test-coverage-attention

    steps:
      - name: All tests passed
        run: |
          echo "# ‚úÖ All Attention Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All attention mechanism tests completed successfully:" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Integration tests (all platforms)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Regression tests (backward compatibility)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Performance benchmarks (meets baseline)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Browser tests (all browsers)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Coverage (>85%)" >> $GITHUB_STEP_SUMMARY
