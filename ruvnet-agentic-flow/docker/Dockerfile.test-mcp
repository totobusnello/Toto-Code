FROM node:22-slim
WORKDIR /app

# Copy local built package
COPY agentic-flow/package.json ./
COPY agentic-flow/dist ./dist
COPY agentic-flow/.claude ./.claude

# Install dependencies and link globally
RUN npm install --omit=dev && npm link

ENV NODE_ENV=production

# Test MCP server tools
CMD ["sh", "-c", "\
echo 'ğŸ§ª Testing Agentic-Flow MCP Tools...' && echo '' && \
\
echo '1ï¸âƒ£ Installing agentic-flow@latest globally for npx access...' && \
npm install -g agentic-flow@latest && \
echo 'âœ… Package installed' && echo '' && \
\
echo '2ï¸âƒ£ Testing direct CLI commands...' && \
agentic-flow --list 2>&1 | grep -q 'coder' && \
echo 'âœ… CLI --list works' && echo '' && \
\
echo '3ï¸âƒ£ Testing npx execution (what MCP server uses)...' && \
npx --yes agentic-flow --list 2>&1 | grep -q 'coder' && \
echo 'âœ… npx --yes agentic-flow --list works' && echo '' && \
\
echo '4ï¸âƒ£ Simulating MCP tool: agentic_flow_list_agents...' && \
node -e \"const { execSync } = require('child_process'); \
const result = execSync('npx --yes agentic-flow --list', { encoding: 'utf-8', maxBuffer: 5 * 1024 * 1024, timeout: 30000 }); \
console.log(JSON.stringify({ success: true, agents: result.trim() }, null, 2));\" && \
echo 'âœ… MCP tool simulation works' && echo '' && \
\
echo '5ï¸âƒ£ Verifying package structure...' && \
test -f dist/mcp/standalone-stdio.js && echo 'âœ… MCP server file exists' && \
test -f dist/cli-proxy.js && echo 'âœ… CLI proxy exists' && \
test -d .claude/agents && echo 'âœ… Agents directory exists' && \
echo '' && \
\
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
echo '  MCP Tools Validation Summary' && \
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
echo 'âœ… agentic_flow_list_agents: Ready' && \
echo 'âœ… agentic_flow_agent: Ready (executes via npx)' && \
echo 'âœ… Package structure: Complete' && \
echo 'âœ… npx execution: Verified' && \
echo '' && \
echo 'ğŸ‰ MCP server is ready for use!' \
"]
