FROM node:22-slim
WORKDIR /app

# Copy local built package
COPY agentic-flow/package.json ./
COPY agentic-flow/dist ./dist
COPY agentic-flow/.claude ./.claude

# Install dependencies and link globally
RUN npm install --omit=dev && npm link

ENV NODE_ENV=production

# Comprehensive test: Config wizard + Provider configuration
CMD ["sh", "-c", "\
echo 'ğŸ§ª Comprehensive Test Suite - agentic-flow' && echo '' && \
\
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
echo '  Part 1: Config Wizard Tests' && \
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && \
\
echo '1ï¸âƒ£ Setting up configuration with wizard...' && \
agentic-flow config set ANTHROPIC_API_KEY sk-ant-test-key-12345 && \
agentic-flow config set PROVIDER anthropic && \
agentic-flow config set COMPLETION_MODEL claude-sonnet-4-5-20250929 && \
echo 'âœ… Configuration set' && echo '' && \
\
echo '2ï¸âƒ£ Listing configuration...' && \
agentic-flow config list && echo '' && \
\
echo '3ï¸âƒ£ Verifying .env file...' && \
test -f .env && echo 'âœ… .env exists' && \
grep -q ANTHROPIC_API_KEY .env && echo 'âœ… API key in .env' && \
grep -q PROVIDER .env && echo 'âœ… Provider in .env' && \
echo '' && \
\
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
echo '  Part 2: CLI Commands' && \
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && \
\
echo '4ï¸âƒ£ Testing --help...' && \
agentic-flow --help | grep -q 'config' && \
echo 'âœ… Help shows config commands' && echo '' && \
\
echo '5ï¸âƒ£ Testing --list...' && \
agentic-flow --list | grep -q 'coder' && \
echo 'âœ… Agent list works' && echo '' && \
\
echo '6ï¸âƒ£ Testing config modification...' && \
agentic-flow config set PROVIDER openrouter && \
agentic-flow config get PROVIDER | grep -q openrouter && \
echo 'âœ… Config modification works' && echo '' && \
\
echo '7ï¸âƒ£ Testing config delete...' && \
agentic-flow config delete ANTHROPIC_API_KEY && \
agentic-flow config get ANTHROPIC_API_KEY | grep -q 'not set' && \
echo 'âœ… Config delete works' && echo '' && \
\
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && \
echo '  Summary' && \
echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•' && echo '' && \
\
echo 'âœ… Config Wizard: Fully functional' && \
echo 'âœ… CLI Commands: All working' && \
echo 'âœ… .env Management: Verified' && echo '' && \
\
echo 'ğŸ‰ All tests passed!' \
"]
